---
phase: 11-glm-integration
plan: 01
type: execute
---

<objective>
Add GLM-4.7 model support to BaseAgent via environment variable configuration.

Purpose: Enable cost-effective alternative LLM (GLM-4.7) without code changes, using existing @anthropic-ai/claude-agent-sdk with its `env` option to pass GLM_API_KEY and GLM_BASE_URL to the spawned Claude Code process.

Output: BaseAgent supports GLM via environment variables; documentation updated with configuration examples.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/PATTERNS.md
@src/agents/BaseAgent.ts
@docs/GLM-4.7_INTEGRATION_RESEARCH2.md

**Post-project context:**
- Project is 100% complete (10/10 phases delivered)
- All agents extend BaseAgent which uses @anthropic-ai/claude-agent-sdk v0.2.7
- BaseAgent.buildOptions() currently returns: systemPrompt, model, hooks
- Agent SDK supports `env` option to pass environment variables to spawned Claude Code process
- GLM provides Anthropic-compatible endpoint at https://api.z.ai/api/coding/paas/v4

**Established patterns:**
- BaseAgent abstract class with protected methods for Convex integration
- Subclasses implement only getSystemPrompt() - BaseAgent handles all SDK details
- Configuration via AgentConfig interface (agentType, model, workflowId)

**Key decision from Phase 3:** Use agent SDK's hooks (SessionStart/SessionEnd) for automatic state persistence rather than wrapper pattern.

**Tech stack available:**
- @anthropic-ai/claude-agent-sdk@0.2.7 with `env` option support
- Existing BaseAgent.buildOptions() method
- dotenv for environment variable loading
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update BaseAgent.buildOptions() to support GLM environment variables</name>
  <files>src/agents/BaseAgent.ts</files>
  <action>Modify buildOptions() to include env option that passes GLM_API_KEY and GLM_BASE_URL to the agent SDK. Add logic to detect GLM configuration and conditionally set ANTHROPIC_API_KEY and ANTHROPIC_BASE_URL. When GLM_API_KEY is set, the model should default to 'glm-4.7' unless explicitly overridden. Keep existing behavior when GLM vars are not set (use Anthropic defaults). DO NOT add new SDK dependencies - use existing agent SDK's env option.</action>
  <verify>Build passes: npm run build succeeds. TypeScript compiles without errors. BaseAgent can be instantiated with GLM env vars set.</verify>
  <done>buildOptions() returns env object with GLM configuration when present. Backward compatible - works without GLM vars set.</done>
</task>

<task type="auto">
  <name>Task 2: Add GLM environment variables to .env.example</name>
  <files>.env.example</files>
  <action>Add GLM_API_KEY and GLM_BASE_URL environment variables to .env.example with clear documentation explaining their purpose and how GLM-4.7 integration works via the compatible endpoint. Include comments that these are optional - when not set, agents use default Anthropic models. Reference PATTERNS.md Pattern 6 for details.</action>
  <verify>.env.example contains GLM_API_KEY and GLM_BASE_URL with descriptive comments.</verify>
  <done>Developers can copy .env.example and see GLM configuration options with clear documentation.</done>
</task>

<task type="auto">
  <name>Task 3: Update PATTERNS.md with GLM configuration section</name>
  <files>.planning/PATTERNS.md</files>
  <action>Update Pattern 6 (Model-Agnostic Body) to reflect the actual implementation using agent SDK's `env` option rather than direct SDK instantiation. Correct the code examples to show how BaseAgent now handles GLM configuration internally via environment variables. Add a "How It Works" section explaining that the agent SDK passes env vars to the spawned Claude Code process, which then routes requests to GLM's compatible endpoint.</action>
  <verify>PATTERNS.md Pattern 6 accurately describes the implemented approach. Examples match actual code in BaseAgent.</verify>
  <done>Documentation matches implementation. Developers can follow Pattern 6 to configure GLM via environment variables.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] No TypeScript errors in src/agents/BaseAgent.ts
- [ ] All existing tests still pass (if any)
- [ ] BaseAgent instantiation works with and without GLM env vars
</verification>

<success_criteria>

- BaseAgent supports GLM-4.7 via GLM_API_KEY and GLM_BASE_URL environment variables
- Backward compatible - existing code works without GLM configuration
- Documentation updated to reflect actual implementation
- No new SDK dependencies added (uses existing agent SDK env option)
  </success_criteria>

<output>
After completion, create `.planning/phases/11-glm-integration/11-01-SUMMARY.md`:

# Phase 11 Plan 1: GLM Integration Summary

**Added GLM-4.7 model support via environment variables using agent SDK's env option**

## Accomplishments

- BaseAgent.buildOptions() now supports GLM_API_KEY and GLM_BASE_URL environment variables
- GLM configuration passed to agent SDK via env option (no new dependencies)
- .env.example documents GLM configuration with clear usage instructions
- PATTERNS.md Pattern 6 updated to reflect actual implementation approach

## Files Created/Modified

- `src/agents/BaseAgent.ts` - Added env option to buildOptions() with GLM support
- `.env.example` - Added GLM_API_KEY and GLM_BASE_URL documentation

## Decisions Made

- Use agent SDK's `env` option (not adding low-level @anthropic-ai/sdk) - maintains existing architecture with minimal changes
- GLM model defaults to 'glm-4.7' when GLM_API_KEY is set
- Backward compatible - GLM vars are optional, defaults to Anthropic when not set

## Issues Encountered

None

## Next Step

Phase 11 complete. GLM integration available via environment variables. Future enhancement could add runtime model switching or additional LLM providers.
</output>

---
phase: 14-template-system
plan: 11
type: execute
wave: 1
depends_on: [10]
files_modified:
  - scripts/dev/template-dev-server.ts
  - packages/template-engine/src/index.ts
  - packages/template-engine/package.json
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Developer can run npm run dev:templates and hot-reload starts"
    - "Modifying a .hbs file in .templates/ triggers re-compilation"
    - "Console logs show '[TemplateWatcher] Template changed:' messages"
  artifacts:
    - path: "scripts/dev/template-dev-server.ts"
      provides: "Development server with hot-reload wired up"
      min_lines: 80
      exports: ["startTemplateDevServer"]
    - path: "package.json"
      provides: "npm run dev:templates script"
      contains: "\"dev:templates\":"
  key_links:
    - from: "scripts/dev/template-dev-server.ts"
      to: "packages/template-engine/src/watcher/template-watcher.ts"
      via: "import { watchTemplates } from '@convex-poc/template-engine/watcher'"
      pattern: "import.*watchTemplates"
    - from: "watchTemplates() call"
      to: "Template engine cache"
      via: "onTemplateChange callback invalidating cache"
      pattern: "onTemplateChange.*invalidate"
---

# Plan 14-11: Hot-Reload Development Server

**Objective:** Wire up the orphaned watchTemplates() function into a working development server

**Purpose:** Make the hot-reload functionality actually work by creating a dev server that calls watchTemplates() and integrates with the template engine cache.

**Output:** Working template hot-reload with automatic cache invalidation

## <context>

@.planning/phases/14-template-system/14-01-SUMMARY.md
@.planning/phases/14-template-system/14-template-system-VERIFICATION.md

# Gap Being Closed

**Gap 2: Hot-Reload Not Wired**

Current state from VERIFICATION.md:
- watchTemplates() function exists (113 lines, fully implemented)
- Uses chokidar with proper debouncing (100ms stability threshold)
- But watchTemplates() is NEVER called or imported anywhere
- No development server exists that would use hot-reload
- Functionality is orphaned - complete but not integrated

What exists:
- Complete watcher implementation in `packages/template-engine/src/watcher/template-watcher.ts`
- Template cache in `handlebars.ts` (line 21: `const templateCache = new Map()`)
- Only missing: the integration layer that calls watchTemplates() and wires it to the cache

## <tasks>

### Task 1: Create template development server

**<files>**
`scripts/dev/template-dev-server.ts`

**<action>**
Create a development server that:
1. Imports watchTemplates from '@convex-poc/template-engine/watcher'
2. Imports createTemplateEngine from '@convex-poc/template-engine/engine'
3. Creates a template engine instance
4. Calls watchTemplates() with:
   - templateDir: '.templates/' (absolute path)
   - onTemplateChange: Invalidate cache and re-load changed template
   - onTemplateAdd: Log new template
   - onTemplateUnlink: Remove from cache
   - onError: Log errors
5. Logs when server starts ("Template dev server watching .templates/ for changes...")
6. Keeps process alive (don't exit immediately)
7. Handles graceful shutdown (close watcher on SIGINT)

Implementation details:
```typescript
import { watchTemplates } from '@convex-poc/template-engine/watcher';
import { createTemplateEngine } from '@convex-poc/template-engine/engine';
import { resolve } from 'path';

const templateDir = resolve('.templates');
const engine = createTemplateEngine();

// Access private cache for invalidation (will need to expose)
const watcher = watchTemplates({
  templateDir,
  onTemplateChange: async (templatePath) => {
    // Invalidate cache and re-load
    console.log(`[HotReload] Reloading: ${templatePath}`);
    // Force re-compilation
    try {
      engine.load(templatePath); // This will update cache
      console.log(`[HotReload] ✓ Reloaded: ${templatePath}`);
    } catch (error) {
      console.error(`[HotReload] ✗ Failed to reload:`, error);
    }
  },
  onTemplateAdd: (templatePath) => {
    console.log(`[HotReload] New template: ${templatePath}`);
  },
  onTemplateUnlink: (templatePath) => {
    console.log(`[HotReload] Deleted template: ${templatePath}`);
  },
  onError: (error) => {
    console.error('[HotReload] Watcher error:', error);
  },
});

console.log('[TemplateDevServer] Watching .templates/ for changes...');
console.log('[TemplateDevServer] Press Ctrl+C to stop');

await watcher.ready;

// Handle graceful shutdown
process.on('SIGINT', async () => {
  console.log('\n[TemplateDevServer] Shutting down...');
  await watcher.close();
  process.exit(0);
});
```

**Note:** Task 2 will expose cache invalidation method from TemplateEngine

**<verify>**
```bash
# Build the package first
pnpm --filter @convex-poc/template-engine build

# Run the dev server
node scripts/dev/template-dev-server.ts
```

Expected output:
```
[TemplateDevServer] Watching .templates/ for changes...
[TemplateDevServer] Press Ctrl+C to stop
```

Then modify a .hbs file and should see:
```
[TemplateWatcher] Template changed: .templates/boilerplate/be/package.json.hbs
[HotReload] Reloading: .templates/boilerplate/be/package.json.hbs
[HotReload] ✓ Reloaded: .templates/boilerplate/be/package.json.hbs
```

**<done>**
- Dev server starts without errors
- Modifying a .hbs file triggers console logs
- watcher.ready promise resolves successfully
- Ctrl+C triggers graceful shutdown

### Task 2: Expose cache invalidation from TemplateEngine

**<files>**
`packages/template-engine/src/engine/handlebars.ts`

**<action>**
Add a `invalidateCache(templatePath?: string)` method to TemplateEngine interface that:
1. Accepts optional template path (if provided, invalidates specific template)
2. If no path provided, clears entire cache
3. Removes template from templateCache Map
4. Returns void

Update TemplateEngine interface:
```typescript
export interface TemplateEngine {
  compile(template: string): HandlebarsTemplateDelegate;
  render(template: string, context: Record<string, unknown>): string;
  load(templatePath: string): HandlebarsTemplateDelegate;
  invalidateCache(templatePath?: string): void; // NEW
}
```

Implement in createTemplateEngine():
```typescript
return {
  // ... existing methods

  invalidateCache(templatePath?: string): void {
    if (templatePath) {
      templateCache.delete(templatePath);
    } else {
      templateCache.clear();
    }
  },
};
```

**<verify>**
```bash
# TypeScript compilation
pnpm --filter @convex-poc/template-engine build
```

**<done>**
- invalidateCache() method exists on TemplateEngine interface
- Calling with no arguments clears entire cache
- Calling with path removes specific template from cache

### Task 3: Update dev server to use cache invalidation

**<files>**
`scripts/dev/template-dev-server.ts`

**<action>**
Update the onTemplateChange handler to call invalidateCache() before re-loading:

```typescript
onTemplateChange: async (templatePath) => {
  console.log(`[HotReload] Reloading: ${templatePath}`);
  try {
    // Invalidate cache first
    engine.invalidateCache(templatePath);
    // Re-load the template
    engine.load(templatePath);
    console.log(`[HotReload] ✓ Reloaded: ${templatePath}`);
  } catch (error) {
    console.error(`[HotReload] ✗ Failed to reload:`, error);
  }
},
```

Also update onTemplateUnlink:
```typescript
onTemplateUnlink: (templatePath) => {
  console.log(`[HotReload] Deleted template: ${templatePath}`);
  engine.invalidateCache(templatePath);
},
```

**<verify>**
```bash
# Run dev server
node scripts/dev/template-dev-server.ts

# In another terminal, modify a .hbs file
echo "// test" >> .templates/boilerplate/be/package.json.hbs
```

Should see hot-reload logs

**<done>**
- Modified templates trigger cache invalidation
- Deleted templates removed from cache
- Re-loading works correctly after cache invalidation

### Task 4: Add npm script for convenience

**<files>**
`package.json` (root)

**<action>**
Add dev:templates script to root package.json:
```json
"scripts": {
  "dev:templates": "node scripts/dev/template-dev-server.ts"
}
```

**<verify>**
```bash
npm run dev:templates
```

Should start the template dev server

**<done>**
- `npm run dev:templates` starts the dev server
- Script is listed in `npm run` output

## </tasks>

## <verification>

### End-to-End Verification

1. **Start dev server:**
   ```bash
   npm run dev:templates
   ```
   Should see: "[TemplateDevServer] Watching .templates/ for changes..."

2. **Test hot-reload:**
   - In terminal 1: `npm run dev:templates`
   - In terminal 2: Modify `.templates/boilerplate/be/package.json.hbs`
   - Should see: "[HotReload] ✓ Reloaded: ..." in terminal 1

3. **Test cache invalidation:**
   - Load a template
   - Modify the file
   - Load again - should get fresh content (not cached)

4. **Test graceful shutdown:**
   - Press Ctrl+C
   - Should see: "[TemplateDevServer] Shutting down..."
   - Process should exit cleanly

## <success_criteria>

- `npm run dev:templates` starts a working development server
- Modifying .hbs files triggers hot-reload with console logs
- Template cache is properly invalidated on changes
- Graceful shutdown works (Ctrl+C)
- No orphaned watcher processes

## <output>

After completion, create `.planning/phases/14-template-system/14-11-SUMMARY.md`

---

**Phase:** 14-template-system
**Plan:** 11 (Gap Closure)
**Type:** Execute
**Wave:** 1 (Depends on 14-10)

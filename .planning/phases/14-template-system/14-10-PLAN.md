---
phase: 14-template-system
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/template-engine/src/engine/handlebars.ts
  - packages/template-engine/src/engine/index.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Developer can call templateEngine.load('.templates/boilerplate/be/package.json.hbs') and get compiled template"
    - "Template loader reads file from disk and compiles with Handlebars engine"
    - "Loaded templates are cached for performance"
  artifacts:
    - path: "packages/template-engine/src/engine/handlebars.ts"
      provides: "Working load() method that reads and compiles templates"
      min_lines: 50
      contains: "load(templatePath: string)"
    - path: "packages/template-engine/src/engine/loader.ts"
      provides: "Template loading utilities with caching"
      exports: ["loadTemplate", "createTemplateLoader"]
  key_links:
    - from: "packages/template-engine/src/engine/handlebars.ts"
      to: ".templates/"
      via: "fs.readFile() in load() method"
      pattern: "readFile.*templatePath"
    - from: "TemplateEngine.load()"
      to: "Handlebars.compile()"
      via: "Direct call with loaded template content"
      pattern: "compile\\(content\\)"
---

# Plan 14-10: Template Auto-Loading Integration

**Objective:** Implement automatic template loading from .templates/ directory with caching

**Purpose:** Enable the TemplateEngine.load() method to actually read and compile .hbs files from the .templates/ directory, replacing the current stub that throws an error.

**Output:** Working template loader with file system integration and caching

## <context>

@.planning/phases/14-template-system/14-01-SUMMARY.md
@.planning/phases/14-template-system/14-template-system-VERIFICATION.md

# Gap Being Closed

**Gap 1: Template Auto-Loading Missing**

Current state from VERIFICATION.md:
- Templates exist (30 .hbs files in .templates/)
- TemplateEngine.load() throws error: "requires file system access - use watcher module"
- No integration code demonstrates loading templates from .templates/
- No automatic template registration on application startup

What exists:
- `packages/template-engine/src/watcher/template-watcher.ts` has `loadTemplate()` and `listTemplates()` utilities
- Template engine has `compile()` and `render()` methods working
- Only missing: the `load()` method on TemplateEngine interface

## <tasks>

### Task 1: Implement TemplateEngine.load() method

**<files>**
`packages/template-engine/src/engine/handlebars.ts`

**<action>**
Replace the stub `load()` method with a working implementation that:
1. Accepts absolute or relative template path (relative to .templates/ if not absolute)
2. Uses `fs.readFile()` to read template content from disk
3. Compiles the template content using the existing `compile()` method
4. Caches compiled templates in the existing `templateCache` Map for performance
5. Returns cached template on subsequent calls (cache hit)
6. Throws clear error if template file doesn't exist

Import statements needed:
```typescript
import { promises as fs } from 'fs';
import { resolve, join } from 'path';
```

Implementation details:
- Resolve path: if `templatePath` is relative, join with `.templates/` directory
- Use `templateCache.get/set` for caching compiled templates
- Cache key should be absolute file path
- Re-throw fs errors with clear message including template path

**<verify>**
```bash
# Create test script
cat > test-template-load.mjs << 'EOF'
import { createTemplateEngine } from './packages/template-engine/src/engine/index.js';
import { resolve } from 'path';

const engine = createTemplateEngine();
const templatePath = resolve('.templates/boilerplate/be/package.json.hbs');

try {
  const template = engine.load(templatePath);
  const output = template({ projectName: 'test-project', description: 'Test description' });
  console.log('✓ Template loaded successfully');
  console.log('Output:', output.substring(0, 100) + '...');
} catch (error) {
  console.error('✗ Template loading failed:', error.message);
  process.exit(1);
}
EOF

node test-template-load.mjs
```

**<done>**
- Calling `engine.load('.templates/boilerplate/be/package.json.hbs')` returns compiled template
- Rendering the template with context produces valid package.json content
- Second call with same path returns cached template (verified by checking cache size)
- Error thrown for non-existent template with clear message

## </tasks>

## <verification>

1. **Template loading works:**
   ```bash
   node test-template-load.mjs
   ```
   Should output valid package.json with projectName and description interpolated

2. **Cache is working:**
   ```bash
   node -e "
   import { createTemplateEngine } from './packages/template-engine/src/engine/index.js';
   const engine = createTemplateEngine();
   engine.load('.templates/boilerplate/be/package.json.hbs');
   engine.load('.templates/boilerplate/be/package.json.hbs');
   console.log('Cache hit on second call');
   "
   ```

3. **Error handling works:**
   ```bash
   node -e "
   import { createTemplateEngine } from './packages/template-engine/src/engine/index.js';
   const engine = createTemplateEngine();
   try {
     engine.load('.templates/nonexistent.hbs');
   } catch (error) {
     console.log('Error message:', error.message);
   }
   "
   ```
   Should include "Failed to load template" and the file path

## <success_criteria>

- TemplateEngine.load() reads and compiles templates from .templates/
- Templates are cached for performance (cache hit on second call)
- Clear error messages when template file doesn't exist
- Works with both absolute paths and relative paths from .templates/
- No breaking changes to existing compile() and render() methods

## <output>

After completion, create `.planning/phases/14-template-system/14-10-SUMMARY.md`

---

**Phase:** 14-template-system
**Plan:** 10 (Gap Closure)
**Type:** Execute
**Wave:** 1 (Independent - can run in parallel with 14-11)

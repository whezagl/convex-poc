---
phase: 14-template-system
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/seeds/school-erp.ddl
  - scripts/seeds/README.md
autonomous: true

must_haves:
  truths:
    - "School ERP DDL file defines 24 tables for Indonesian school management"
    - "DDL uses PostgreSQL 17 syntax (JSONB, arrays, enums, identity columns)"
    - "Tables cover students, teachers, classes, subjects, enrollments, attendance, grades, fees"
    - "Indonesian national ID fields are included (NISN, NIP, NUPTK) with proper constraints"
    - "Kurikulum Merdeka P5 projects are supported in curriculum tables"
    - "Foreign key constraints maintain referential integrity"
    - "Indexes are defined for common query patterns"
  artifacts:
    - path: "scripts/seeds/school-erp.ddl"
      provides: "PostgreSQL 17 DDL with 24 tables for School ERP"
      contains: "CREATE TABLE"
      min_lines: 500
    - path: "scripts/seeds/README.md"
      provides: "Documentation for School ERP schema"
      contains: "table descriptions, relationships, usage"
  key_links:
    - from: "scripts/seeds/school-erp.ddl"
      to: "PostgreSQL 17 database"
      via: "psql execution or migration tool"
      pattern: "CREATE TABLE|ALTER TABLE|CREATE INDEX"
---

<objective>
Build comprehensive School ERP DDL with 24 tables covering Indonesian school management, Kurikulum Merdeka support, and national ID validation.

Purpose: This DDL serves as the test case for DDL parser validation and provides realistic domain schema for seed data generation. It demonstrates PostgreSQL 17 features and Indonesian school domain knowledge.
Output: Complete school-erp.ddl file with 24 tables, ready for parsing and seed data generation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/14-template-system/14-CONTEXT.md
@.planning/phases/14-template-system/14-RESEARCH.md

@scripts/seeds/README.md
</context>

<tasks>

<task type="auto">
  <name>Create School ERP DDL with core student and teacher tables</name>
  <files>scripts/seeds/school-erp.ddl</files>
  <action>
    Create PostgreSQL 17 DDL with 24 tables for Indonesian School ERP:

    Create `scripts/seeds/school-erp.ddl` with the following structure (24 tables total):

    **Core Tables (1-8):**
    1. `schools` - School information (npsn, name, address, accreditation)
    2. `students` - Student records (nisn, name, birth_date, enrollment_status)
    3. `teachers` - Teacher records (nip, nuptk, name, subject, status)
    4. `parents` - Parent/guardian information (name, relationship, phone)
    5. `admins` - School admin staff (name, role, email)
    6. `classes` - Class/group definitions (name, grade_level, academic_year)
    7. `subjects` - Subject offerings (name, code, curriculum_type)
    8. `class_teachers` - Junction table for teacher-class assignments

    **Academic Tables (9-14):**
    9. `enrollments` - Student-class enrollment records
    10. `subject_teachers` - Teacher-subject assignments
    11. `class_subjects` - Subject offerings per class
    12. `schedules` - Class schedule/time assignments
    13. `attendance` - Student attendance records
    14. `grade_components` - Grading criteria (assignments, exams, projects)

    **Assessment Tables (15-18):**
    15. `grades` - Student grade records per component
    16. `p5_projects` - Kurikulum Merdeka P5 project definitions
    17. `p5_enrollments` - Student participation in P5 projects
    18. `p5_assessments` - P5 descriptive grading (sangat baik, baik, cukup, perlu bimbingan)

    **Administrative Tables (19-24):**
    19. `fees` - Student fee records (tuition, books, uniforms)
    20. `fee_payments` - Payment transaction records
    21. `announcements` - School announcements and notices
    22. `events` - School calendar events
    23. `documents` - Document storage (reports, certificates)
    24. `user_accounts` - System user accounts for portal access

    **Key PostgreSQL 17 Features to Include:**
    - Identity columns: `id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY`
    - JSONB columns: `metadata JSONB DEFAULT '{}'` for flexible attributes
    - Array columns: `phone_numbers TEXT[]` for multiple contacts
    - Enum types: Custom enums for status fields
    - Check constraints: Validate NISN (10 digits), NIP (18 digits), NUPTK (16 digits)
    - Foreign keys with ON DELETE CASCADE for referential integrity
    - Indexes on frequently queried columns

    **Indonesian Domain Specifics:**
    - NPSN (Nomor Pokok Sekolah Nasional): 8-digit school ID
    - NISN (Nomor Induk Siswa Nasional): 10-digit student ID
    - NIP (Nomor Induk Pegawai): 18-digit teacher/employee ID
    - NUPTK (Nomor Unik Pendidik dan Tenaga Kependidikan): 16-digit educator ID
    - Kurikulum Merdeka: P5 projects with descriptive grading (not numeric)

    **Sample Table Structure:**
    ```sql
    -- Students table with Indonesian national ID
    CREATE TABLE students (
        id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
        nisn VARCHAR(10) UNIQUE NOT NULL,
        name VARCHAR(255) NOT NULL,
        birth_date DATE NOT NULL,
        gender VARCHAR(10) NOT NULL CHECK (gender IN ('Laki-laki', 'Perempuan')),
        address TEXT,
        phone VARCHAR(20),
        email VARCHAR(255),
        enrollment_status VARCHAR(20) DEFAULT 'aktif' CHECK (enrollment_status IN ('aktif', 'non-aktif', 'lulus', 'keluar')),
        parent_id BIGINT REFERENCES parents(id) ON DELETE SET NULL,
        enrollment_date DATE NOT NULL DEFAULT CURRENT_DATE,
        metadata JSONB DEFAULT '{}',
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );

    CREATE INDEX idx_students_nisn ON students(nisn);
    CREATE INDEX idx_students_status ON students(enrollment_status);
    CREATE INDEX idx_students_parent ON students(parent_id);

    -- Teachers with NIP and NUPTK
    CREATE TABLE teachers (
        id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
        nip VARCHAR(18) UNIQUE NOT NULL,
        nuptk VARCHAR(16),
        name VARCHAR(255) NOT NULL,
        gender VARCHAR(10) NOT NULL CHECK (gender IN ('Laki-laki', 'Perempuan')),
        birth_date DATE NOT NULL,
        phone VARCHAR(20),
        email VARCHAR(255),
        subject VARCHAR(100),
        employment_status VARCHAR(20) DEFAULT 'aktif' CHECK (employment_status IN ('aktif', 'non-aktif', 'pensiun')),
        hire_date DATE NOT NULL,
        metadata JSONB DEFAULT '{}',
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );

    CREATE INDEX idx_teachers_nip ON teachers(nip);
    CREATE INDEX idx_teachers_nuptk ON teachers(nuptk);

    -- Kurikulum Merdeka P5 projects
    CREATE TYPE p5_theme AS ENUM ('kebinekaan', 'gotong_royong', 'berkarya', 'berdoa', 'sehat',    'sadar_budaya', 'kreatif', 'rekat');

    CREATE TABLE p5_projects (
        id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
        name VARCHAR(255) NOT NULL,
        theme p5_theme NOT NULL,
        description TEXT,
        duration_weeks INT NOT NULL CHECK (duration_weeks > 0),
        academic_year VARCHAR(9) NOT NULL, -- Format: 2024/2025
        semester INT NOT NULL CHECK (semester IN (1, 2)),
        class_id BIGINT REFERENCES classes(id) ON DELETE CASCADE,
        teacher_id BIGINT REFERENCES teachers(id) ON DELETE SET NULL,
        start_date DATE NOT NULL,
        end_date DATE NOT NULL,
        metadata JSONB DEFAULT '{}',
        created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
        CHECK (end_date > start_date)
    );

    CREATE INDEX idx_p5_class ON p5_projects(class_id);
    CREATE INDEX idx_p5_academic_year ON p5_projects(academic_year);
    ```

    Include all 24 tables with proper constraints, indexes, and relationships. Use Indonesian language for check constraint values and enum values where appropriate.
  </action>
  <verify>
    - File exists at scripts/seeds/school-erp.ddl
    - `grep -c "CREATE TABLE" scripts/seeds/school-erp.ddl` returns 24
    - DDL syntax is valid PostgreSQL 17 (check for identity columns, JSONB, arrays)
    - Indonesian national ID fields are present (NISN, NIP, NUPTK)
    - Foreign key constraints use ON DELETE CASCADE or SET NULL appropriately
    - Indexes are created on foreign key columns and frequently queried fields
  </verify>
  <done>
    School ERP DDL with 24 tables is created and ready for parsing
  </done>
</task>

<task type="auto">
  <name>Document School ERP schema structure</name>
  <files>scripts/seeds/README.md</files>
  <action>
    Create comprehensive documentation for School ERP schema:

    Create `scripts/seeds/README.md` with:

    1. **Overview**: Purpose of School ERP database and Indonesian school domain
    2. **Table Listing**: All 24 tables with brief descriptions
    3. **Relationships**: ER diagram description (text format) showing foreign key relationships
    4. **Indonesian Domain Specifics**:
       - NPSN, NISN, NIP, NUPTK formats and validation rules
       - Kurikulum Merdeka P5 project structure
       - Descriptive grading system (sangat baik, baik, cukup, perlu bimbingan)
    5. **PostgreSQL 17 Features Used**:
       - Identity columns
       - JSONB columns
       - Array types
       - Custom enums
       - Check constraints
    6. **Indexes**: List of all indexes and their purpose
    7. **Usage Instructions**: How to load DDL into PostgreSQL
    8. **Seed Data Generation**: Reference to npm run seeds script (Plan 14-09)

    Example structure:
    ```markdown
    # School ERP Database Schema

    ## Overview
    This schema supports Indonesian school management with Kurikulum Merdeka curriculum.

    ## Tables (24 total)

    ### Core Tables
    - `schools` - School information with NPSN (8-digit national school ID)
    - `students` - Student records with NISN (10-digit national student ID)
    - `teachers` - Teacher records with NIP (18-digit) and NUPTK (16-digit)
    ...

    ## Relationships
    ```
    students (1) ----< (N) enrollments >---- (1) classes
    teachers (1) ----< (N) class_teachers >---- (1) classes
    ...
    ```

    ## National ID Validation
    - NISN: 10 digits, numeric
    - NIP: 18 digits, numeric
    - NUPTK: 16 digits, numeric

    ## P5 Projects (Kurikulum Merdeka)
    P5 (Projek Penguatan Profil Pelajar Pancasila) supports project-based learning.
    Themes: kebinekaan, gotong_royong, berkarya, berdoa, sehat, sadar_budaya, kreatif, rekat

    ## Usage
    ```bash
    psql -h localhost -p 5433 -U postgres -d school_erp -f scripts/seeds/school-erp.ddl
    ```
    ```
  </action>
  <verify>
    - README.md exists at scripts/seeds/README.md
    - All 24 tables are listed with descriptions
    - Indonesian domain specifics are documented
    - PostgreSQL 17 features are explained
    - Usage instructions are clear and accurate
  </verify>
  <done>
    School ERP schema is documented with relationships and domain knowledge
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
- scripts/seeds/school-erp.ddl contains exactly 24 CREATE TABLE statements
- DDL uses PostgreSQL 17 syntax (identity, JSONB, arrays, enums)
- Indonesian national ID fields (NISN, NIP, NUPTK) are present with constraints
- Kurikulum Merdeka P5 projects are represented with appropriate tables
- Foreign key constraints maintain referential integrity
- Indexes are defined for common query patterns
- README.md documents all tables, relationships, and domain specifics
</verification>

<success_criteria>
1. School ERP DDL defines 24 tables covering complete school management
2. DDL parses successfully with PostgreSQL 17 syntax
3. Indonesian national IDs (NISN, NIP, NUPTK) are validated with check constraints
4. Kurikulum Merdeka P5 projects support descriptive grading
5. Foreign keys and indexes ensure data integrity and query performance
6. README.md provides clear documentation for schema usage
</success_criteria>

<output>
After completion, create `.planning/phases/14-template-system/14-08-SUMMARY.md`
</output>

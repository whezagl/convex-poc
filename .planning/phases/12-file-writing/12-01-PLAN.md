---
phase: 12-file-writing
plan: 01
type: execute
---

<objective>
Implement actual file operations in CoderAgent and ReviewerAgent to close the loop on multi-agent workflow.

Purpose: Currently, CoderAgent returns file change instructions as JSON but doesn't write actual files to workspace. ReviewerAgent reviews the JSON structure instead of actual source code. This phase implements real file operations to make the workflow complete and practical.

Output: CoderAgent writes files to workspace, ReviewerAgent reads actual source files, SequentialOrchestrator coordinates the file operations.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key files from frontmatter (relevant to this phase):
@src/agents/CoderAgent.ts
@src/agents/ReviewerAgent.ts
@src/orchestrator/SequentialOrchestrator.ts
@src/orchestrator/state.ts
@src/types/code.ts
@src/types/review.ts
@src/types/workflow.ts

**Tech stack available:** Node.js fs/promises, path/join (already in state.ts)
**Established patterns:**
- Filesystem state passing via JSON artifacts (plan.json, code.json, review.json)
- createWorkspace(), saveArtifact(), loadArtifact() utilities in state.ts
- SequentialOrchestrator manages agent execution with workspace path

**Constraining decisions:**
- [Phase 07-01]: SequentialOrchestrator uses filesystem state passing (plan.json → code.json → review.json)
- [Phase 05-01]: CodeResult has changes array with FileChange (path, content, operation)
- [Phase 06-01]: ReviewResult interface defined with issues array
- [Phase 03-01]: BaseAgent handles Convex integration, subclasses implement execute*() methods

**Issues being addressed:** None

**Current behavior to modify:**
- CoderAgent.executeCode() returns CodeResult but doesn't write files
- ReviewerAgent.executeReview() receives JSON string, not actual files
- SequentialOrchestrator saves JSON artifacts but not source files
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add file operations to CoderAgent</name>
  <files>src/agents/CoderAgent.ts, src/agents/BaseAgent.ts</files>
  <action>Add applyFileChanges() method to CoderAgent that:
1. Accepts workspace path and CodeResult.changes array
2. Uses fs.promises.writeFile for create/update operations
3. Uses fs.promises.rm for delete operations
4. Creates parent directories with mkdir(recursive: true) before writing
5. Returns list of files written

Modify executeCode() to optionally apply changes:
- Add optional workspacePath parameter to executeCode()
- If workspacePath provided, call applyFileChanges() after parsing CodeResult
- Log each file operation for visibility

DO NOT modify executeWithWorkflow() - let orchestrator handle file operations.

Import fs/promises and path/join at top of file.</action>
  <verify>npm run build succeeds with TypeScript, no errors in CoderAgent.ts</verify>
  <done>CoderAgent.applyFileChanges() method exists and handles create/update/delete operations with directory creation</done>
</task>

<task type="auto">
  <name>Task 2: Update ReviewerAgent to read actual files</name>
  <files>src/agents/ReviewerAgent.ts, src/types/review.ts</files>
  <action>Modify ReviewerAgent to accept workspace path and read actual source files:

1. Add optional workspacePath parameter to executeReview()
2. If workspacePath provided, extract file paths from the code.json in input
3. Read actual file contents using fs.promises.readFile
4. Build review input with actual file contents instead of JSON
5. Pass file contents to LLM as formatted string with file paths and line numbers

Input format when workspace provided:
```
Task: {task}
Plan: {planJson}
Files to review:
- src/utils/emailValidator.ts
  (actual file content here)
- src/utils/emailValidator.test.ts
  (actual file content here)
```

Import fs/promises and path/join at top of file.

DO NOT modify executeWithWorkflow() - let orchestrator handle file operations.</action>
  <verify>npm run build succeeds, no errors in ReviewerAgent.ts</verify>
  <done>ReviewerAgent reads actual file contents from workspace when workspacePath provided</done>
</task>

<task type="auto">
  <name>Task 3: Update SequentialOrchestrator to coordinate file operations</name>
  <files>src/orchestrator/SequentialOrchestrator.ts</files>
  <action>Modify SequentialOrchestrator to pass workspace path and coordinate file operations:

1. In executeCoder(): Pass this.config.workspace to coder.executeCode()
   - Change: `const code: CodeResult = await coder.executeCode(planInput);`
   - To: `const code: CodeResult = await coder.executeCode(planInput, this.config.workspace);`

2. In executeReviewer(): Pass this.config.workspace to reviewer.executeReview()
   - Change: `const review: ReviewResult = await reviewer.executeReview(reviewInput);`
   - To: `const review: ReviewResult = await reviewer.executeReview(reviewInput, this.config.workspace);`

3. Simplify reviewer input - pass task and plan only (let reviewer read actual files):
   - Change reviewInput to only include task and plan: `const reviewInput = \`Task: ${task}\n\nPlan:\n${planJson}\`;`
   - Remove code.json from reviewInput since reviewer will read actual files

Files are written by CoderAgent, then read by ReviewerAgent directly from workspace.</action>
  <verify>npm run build succeeds, SequentialOrchestrator compiles without errors</verify>
  <done>SequentialOrchestrator passes workspace to agents, coordinates file write/read operations</done>
</task>

<task type="auto">
  <name>Task 4: Update CodeResult and ReviewResult types for file operations</name>
  <files>src/types/code.ts, src/types/review.ts</files>
  <action>Add filesWritten field to CodeResult interface:

1. Add optional `filesWritten?: string[]` to CodeResult interface
2. This tracks actual files written by CoderAgent.applyFileChanges()
3. Initialize to empty array if no workspace provided

No changes needed to ReviewResult - it already tracks filesReviewed correctly.</action>
  <verify>npm run build succeeds, type definitions are valid</verify>
  <done>CodeResult.filesWritten field exists for tracking actual files written</done>
</task>

<task type="auto">
  <name>Task 5: Add file operation utilities to state.ts</name>
  <files>src/orchestrator/state.ts</files>
  <action>Add helper utilities for file operations:

1. Add writeFilesToWorkspace() function:
   - Accepts workspace path and FileChange[] array
   - Handles create/update with writeFile()
   - Handles delete with rm()
   - Creates parent directories with mkdir()
   - Returns list of files written

2. Add readFilesFromWorkspace() function:
   - Accepts workspace path and file paths array
   - Returns map of path to content
   - Handles missing files gracefully

These utilities can be used by agents but agents should also implement their own logic for clarity.

Keep existing functions (createWorkspace, saveArtifact, etc.) unchanged.</action>
  <verify>npm run build succeeds, state.ts utilities are exported and valid</verify>
  <done>File operation utilities available in state.ts for workspace management</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete file writing implementation across CoderAgent, ReviewerAgent, and SequentialOrchestrator</what-built>
  <how-to-verify>
    1. Run: npm run build (should succeed without errors)
    2. Check: CoderAgent.applyFileChanges() method exists
    3. Check: ReviewerAgent accepts workspacePath parameter
    4. Check: SequentialOrchestrator passes workspace to both agents
    5. Run the example (if ANTHROPIC_API_KEY set):
       - Set ANTHROPIC_API_KEY
       - Uncomment executeWorkflow() in examples/real-example.ts
       - Run: npx tsx examples/real-example.ts
    6. Verify: Actual source files appear in workspace-email-validator/
    7. Verify: ReviewerAgent reviews actual files, not JSON
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] CoderAgent.applyFileChanges() method writes files to workspace
- [ ] ReviewerAgent reads actual file contents from workspace
- [ ] SequentialOrchestrator coordinates file operations correctly
- [ ] Example workflow creates actual source files in workspace
- [ ] No TypeScript errors
- [ ] All existing tests still pass
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- File operations work end-to-end (write to workspace, read from workspace)
- Example workflow produces actual source files
  </success_criteria>

<output>
After completion, create `.planning/phases/12-file-writing/12-01-SUMMARY.md`:

# Phase 12 Plan 1: File Writing Implementation Summary

**Implemented actual file operations in CoderAgent and ReviewerAgent to close the loop on multi-agent workflow**

## Accomplishments

- Added applyFileChanges() method to CoderAgent for writing files to workspace
- Modified ReviewerAgent to read actual source files from workspace for review
- Updated SequentialOrchestrator to pass workspace path and coordinate file operations
- Added CodeResult.filesWritten field to track actual files written
- Created file operation utilities in state.ts for workspace management

## Files Created/Modified

- `src/agents/CoderAgent.ts` - Added applyFileChanges() method, modified executeCode() signature
- `src/agents/ReviewerAgent.ts` - Modified to read actual files from workspace
- `src/orchestrator/SequentialOrchestrator.ts` - Updated to pass workspace to agents
- `src/types/code.ts` - Added filesWritten field to CodeResult interface
- `src/orchestrator/state.ts` - Added writeFilesToWorkspace() and readFilesFromWorkspace() utilities

## Decisions Made

- File operations implemented in agents (not just utilities) for clarity and separation of concerns
- Workspace path passed as optional parameter to maintain backward compatibility
- Reviewer input simplified to task + plan only (reads actual files independently)
- SequentialOrchestrator coordinates the workflow without handling file operations directly

## Issues Encountered

None.

## Next Step

**Phase 12 complete, milestone v0.3 complete**

Multi-agent workflow now has full file operation capability:
- PlannerAgent creates plan
- CoderAgent writes actual source files to workspace
- ReviewerAgent reviews actual source code
- Complete cycle from task to reviewed code

Ready for v0.3 milestone completion and next project direction.
</output>

---
phase: 13-foundation
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
  - docker-compose.dev.yml
  - .env.example
autonomous: true

must_haves:
  truths:
    - "Developer can run docker-compose up and Convex + PostgreSQL containers start successfully"
    - "PostgreSQL is accessible on port 5433 (custom port to avoid conflicts)"
    - "Data persists across container restarts via bind mounts"
  artifacts:
    - path: "docker-compose.yml"
      provides: "Base Convex backend and dashboard configuration"
      contains: "convex-backend, convex-dashboard services"
    - path: "docker-compose.dev.yml"
      provides: "PostgreSQL 17 override for development"
      contains: "postgres:17 service with port 5433"
    - path: ".env.example"
      provides: "Environment variable template"
      contains: "POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB"
    - path: "data/pg"
      provides: "PostgreSQL data persistence"
      exists: true (bind mount)
    - path: "data/convex"
      provides: "Convex data persistence"
      exists: true (bind mount)
  key_links:
    - from: "docker-compose.dev.yml"
      to: "docker-compose.yml"
      via: "Docker Compose override pattern"
      pattern: "docker-compose -f docker-compose.yml -f docker-compose.dev.yml up"
    - from: "applications"
      to: "postgres:5433"
      via: "Connection string with custom port"
      pattern: "postgresql://.*:5433/.*"
---

<objective>
Configure Docker Compose with Convex backend and PostgreSQL 17 containers.

Purpose: Provide self-hosted infrastructure for local development. PostgreSQL is needed for future phases (School ERP DDL, complex queries). Custom port avoids conflicts with local PostgreSQL installations.
Output: Working Docker Compose setup with Convex + PostgreSQL, data persistence via bind mounts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/13-foundation/13-CONTEXT.md
@.planning/phases/13-foundation/13-RESEARCH.md

@docker-compose.yml
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Create Docker Compose override file with PostgreSQL 17</name>
  <files>docker-compose.dev.yml</files>
  <action>
    Create docker-compose.dev.yml override file:

    **File: `docker-compose.dev.yml`**
    ```yaml
    services:
      postgres:
        image: postgres:17
        container_name: convex-poc-postgres
        ports:
          - "5433:5432"  # Custom port to avoid conflicts with local PostgreSQL
        environment:
          POSTGRES_USER: ${POSTGRES_USER:-postgres}
          POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
          POSTGRES_DB: ${POSTGRES_DB:-convex_poc}
        volumes:
          - ./data/pg:/var/lib/postgresql/data  # Bind mount for data persistence
        restart: unless-stopped
        healthcheck:
          test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
          interval: 10s
          timeout: 5s
          retries: 5
    ```

    Key decisions from RESEARCH.md and CONTEXT.md:
    - PostgreSQL 17 (latest version, supports JSONB, arrays, enums for School ERP)
    - Custom port 5433 to avoid conflicts with local PostgreSQL installation (Pitfall 4)
    - Bind mount `./data/pg` for data persistence (not named volume - easier visibility/debugging)
    - Environment variables with defaults (can override via .env)
    - Healthcheck for container readiness monitoring
    - Multi-file override pattern (base + dev) for environment separation

    Note: Existing docker-compose.yml has `volumes: convex_data:` (named volume for Convex).
    We keep that for Convex and use bind mount for PostgreSQL per CONTEXT.md decision.
  </action>
  <verify>
    - Run `docker-compose config` to validate override syntax
    - Verify merge: `docker-compose -f docker-compose.yml -f docker-compose.dev.yml config`
    - Check that postgres service is merged into base configuration
    - Ensure no duplicate or conflicting service definitions
  </verify>
  <done>
    Docker Compose override file is created and syntax is valid
  </done>
</task>

<task type="auto">
  <name>Update .env.example with PostgreSQL environment variables</name>
  <files>.env.example</files>
  <action>
    Update .env.example to include PostgreSQL configuration:

    Add to existing .env.example:
    ```bash
    # === PostgreSQL Configuration ===
    # Used for School ERP DDL and complex queries (Phase 14+)
    # Custom port 5433 to avoid conflicts with local PostgreSQL

    POSTGRES_USER=postgres
    POSTGRES_PASSWORD=postgres
    POSTGRES_DB=convex_poc

    # Connection string format:
    # postgresql://postgres:postgres@localhost:5433/convex_poc
    ```

    Place after Convex configuration section, before GLM configuration.

    Key decisions:
    - Default credentials (postgres/postgres) for local development
    - Database name matches project (convex_poc)
    - Include connection string format comment for easy reference
    - Custom port 5433 documented

    Do NOT change existing Convex or GLM environment variables - only add PostgreSQL section.
  </action>
  <verify>
    - Compare with existing .env to ensure no production secrets are in .env.example
    - Verify all new PostgreSQL variables are documented
    - Check that connection string format is correct
    - Ensure file is valid (no syntax errors)
  </verify>
  <done>
    .env.example includes PostgreSQL environment variables with documentation
  </done>
</task>

<task type="auto">
  <name>Create data directories and test Docker Compose startup</name>
  <files>data/convex/, data/pg/</files>
  <action>
    Create data directories and test container startup:

    1. Create data directories:
    ```bash
    mkdir -p data/convex data/pg
    ```

    2. Update .gitignore to exclude data directories:
    ```
    # Persisted data
    data/
    !data/.gitkeep
    ```
    (Create data/.gitkeep to preserve directory structure in git)

    3. Start containers with override:
    ```bash
    docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d
    ```

    4. Verify containers are running:
    ```bash
    docker-compose ps
    ```
    Expected output:
    - convex-backend: running (ports 3210, 3211)
    - convex-dashboard: running (port 6791)
    - postgres: running (port 5433)

    5. Test PostgreSQL connection:
    ```bash
    docker exec -it convex-poc-postgres psql -U postgres -d convex_poc -c "SELECT version();"
    ```
    Expected: PostgreSQL 17.x version string

    6. Test Convex backend:
    ```bash
    curl http://localhost:3210/
    ```
    Expected: Convex backend response

    7. Stop containers after verification:
    ```bash
    docker-compose -f docker-compose.yml -f docker-compose.dev.yml down
    ```

    Key verification points:
    - All three containers start successfully
    - PostgreSQL is on port 5433 (not 5432)
    - Data directories are created and persist across restarts
    - Convex dashboard accessible at http://localhost:6791
  </action>
  <verify>
    - Run `docker-compose ps` - all services show "Up" status
    - Run `docker exec -it convex-poc-postgres psql -U postgres -d convex_poc -c "\l"` - lists databases
    - Visit http://localhost:6791 - Convex dashboard loads
    - Run `ls -la data/` - both convex/ and pg/ directories exist
    - Test persistence: restart containers, verify data still exists
  </verify>
  <done>
    Docker Compose starts all containers successfully, PostgreSQL is accessible on port 5433, data persists across restarts
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
- `docker-compose -f docker-compose.yml -f docker-compose.dev.yml config` validates syntax
- `docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d` starts all containers
- `docker-compose ps` shows convex-backend, convex-dashboard, postgres all running
- PostgreSQL is accessible on port 5433 (not 5432)
- `docker exec -it convex-poc-postgres psql` connects successfully
- Convex dashboard loads at http://localhost:6791
- Data directories (data/convex/, data/pg/) exist and persist data
- .env.example includes PostgreSQL variables with documentation
</verification>

<success_criteria>
1. Docker Compose override file exists with PostgreSQL 17 service
2. PostgreSQL uses custom port 5433 to avoid conflicts
3. Data persists across container restarts via bind mounts
4. All containers (Convex backend, dashboard, PostgreSQL) start successfully
5. .env.example includes PostgreSQL environment variables
</success_criteria>

<output>
After completion, create `.planning/phases/13-foundation/13-05-SUMMARY.md`
</output>

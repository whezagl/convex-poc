---
phase: 13-foundation
plan: 04
type: execute
wave: 4
depends_on: [13-02, 13-03]
files_modified:
  - packages/convex-client/package.json
  - packages/convex-client/src/client.ts
  - packages/convex-client/src/tasks.ts
  - packages/convex-client/src/subtasks.ts
autonomous: true

must_haves:
  truths:
    - "@repo/convex-client provides type-safe queries and mutations to backend"
    - "TypeScript types from @convex-poc/shared-types are used throughout client"
    - "Convex client is properly initialized and exportable"
  artifacts:
    - path: "packages/convex-client/package.json"
      provides: "Convex client wrapper package"
      exports: ["./client", "./tasks", "./subtasks"]
    - path: "packages/convex-client/src/client.ts"
      provides: "Convex client initialization"
      exports: ["createConvexClient", "getConvexClient"]
    - path: "packages/convex-client/src/tasks.ts"
      provides: "Type-safe task query/mutation wrappers"
      exports: ["getTasks", "createTask", "updateTaskStatus", "addTaskLog"]
    - path: "packages/convex-client/src/subtasks.ts"
      provides: "Type-safe subtask query/mutation wrappers"
      exports: ["getSubTasksByTask", "createSubTask", "updateSubTaskStatus"]
  key_links:
    - from: "packages/convex-client/src/tasks.ts"
      to: "convex/tasks.ts"
      via: "Convex client function calls"
      pattern: "convexClient\\.mutation\\(.*createTask"
    - from: "packages/convex-client"
      to: "@convex-poc/shared-types"
      via: "import { Task, SubTask } from '@convex-poc/shared-types/...'"
      pattern: "@convex-poc/shared-types/\\w+"
---

<objective>
Build @convex-poc/convex-client package with type-safe queries and mutations.

Purpose: Provide a clean, type-safe wrapper around Convex client that integrates with shared types. This package will be used by Electron main process and React renderer to interact with the backend.
Output: Convex client package with type-safe wrappers for all backend functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/13-foundation/13-CONTEXT.md
@.planning/phases/13-foundation/13-RESEARCH.md

@convex/schema.ts
@convex/tasks.ts
@convex/subtasks.ts
@.planning/phases/13-foundation/13-02-SUMMARY.md
@.planning/phases/13-foundation/13-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create Convex client initialization module</name>
  <files>packages/convex-client/src/client.ts, packages/convex-client/package.json</files>
  <action>
    Create packages/convex-client package and client initialization:

    **File: `packages/convex-client/package.json`**
    ```json
    {
      "name": "@convex-poc/convex-client",
      "version": "0.1.0",
      "type": "module",
      "private": true,
      "exports": {
        "./client": "./src/client.ts",
        "./tasks": "./src/tasks.ts",
        "./subtasks": "./src/subtasks.ts"
      },
      "scripts": {
        "build": "tsc",
        "test": "vitest run"
      },
      "dependencies": {
        "convex": "^1.31.4",
        "@convex-poc/shared-types/task": "workspace:*",
        "@convex-poc/shared-types/subtask": "workspace:*",
        "@convex-poc/shared-types/log": "workspace:*"
      },
      "devDependencies": {
        "typescript": "workspace:*",
        "@types/node": "workspace:*"
      }
    }
    ```

    **File: `packages/convex-client/src/client.ts`**
    ```typescript
    import { ConvexClient } from "convex/browser";

    let clientInstance: ConvexClient | null = null;

    /**
     * Initialize Convex client with environment configuration
     * Uses CONVEX_URL from environment or defaults to local development
     */
    export function createConvexClient(): ConvexClient {
      if (clientInstance) {
        return clientInstance;
      }

      const convexUrl = process.env.CONVEX_URL || "http://127.0.0.1:3210";

      clientInstance = new ConvexClient(convexUrl, {
        // Note: In production with auth, configure authenticateUrl
        // For this POC, we skip auth (Phase 13 is self-hosted local only)
      });

      return clientInstance;
    }

    /**
     * Get or create the singleton Convex client instance
     */
    export function getConvexClient(): ConvexClient {
      if (!clientInstance) {
        return createConvexClient();
      }
      return clientInstance;
    }

    /**
     * Close the Convex client and cleanup subscriptions
     * Call this when shutting down the application
     */
    export function closeConvexClient(): void {
      if (clientInstance) {
        clientInstance.close();
        clientInstance = null;
      }
    }
    ```

    Key decisions:
    - Singleton pattern for Convex client (single connection per app)
    - Uses CONVEX_URL environment variable (defaults to local self-hosted)
    - Includes cleanup function for subscription management (Phase 17 memory leak prevention)
    - No auth configuration in Phase 13 (single-user POC)

    Add dependencies: `pnpm add convex@^1.31.4` and shared-types workspace deps
  </action>
  <verify>
    - Run `pnpm install` in root to resolve dependencies
    - Run `tsc --noEmit` in packages/convex-client - should compile without errors
    - Test client initialization: create a test file that calls createConvexClient()
    - Verify CONVEX_URL is read from environment
  </verify>
  <done>
    Convex client initialization module is created and compiles successfully
  </done>
</task>

<task type="auto">
  <name>Create type-safe task query/mutation wrappers</name>
  <files>packages/convex-client/src/tasks.ts</files>
  <action>
    Create type-safe wrappers for task operations:

    **File: `packages/convex-client/src/tasks.ts`**
    ```typescript
    import type { ConvexClient } from "convex/browser";
    type { FunctionArgs, FunctionReference } from "convex/browser";

    import type { Task, TaskStatus, TaskPriority } from "@convex-poc/shared-types/task";
    import type { Log } from "@convex-poc/shared-types/log";

    import { getConvexClient } from "./client";

    /**
     * Get all tasks (for Kanban board)
     */
    export async function getTasks(client?: ConvexClient): Promise<Task[]> {
      const convex = client || getConvexClient();
      return await convex.query("api/tasks:getTasks", {});
    }

    /**
     * Get tasks by status (for Kanban columns)
     */
    export async function getTasksByStatus(
      status: TaskStatus,
      client?: ConvexClient
    ): Promise<Task[]> {
      const convex = client || getConvexClient();
      return await convex.query("api/tasks:getTasksByStatus", { status });
    }

    /**
     * Create a new task
     */
    export async function createTask(
      args: {
        title: string;
        description?: string;
        priority: TaskPriority;
        workspacePath?: string;
      },
      client?: ConvexClient
    ): Promise<string> {
      const convex = client || getConvexClient();
      const taskId = await convex.mutation("api/tasks:createTask", args);
      return taskId;
    }

    /**
     * Update task status
     */
    export async function updateTaskStatus(
      args: {
        taskId: string;
        status: TaskStatus;
        pauseReason?: "user" | "auto";
      },
      client?: ConvexClient
    ): Promise<void> {
      const convex = client || getConvexClient();
      await convex.mutation("api/tasks:updateTaskStatus", args);
    }

    /**
     * Add log to task
     */
    export async function addTaskLog(
      args: {
        taskId: string;
        message: string;
        level: "info" | "warning" | "error";
        source?: string;
      },
      client?: ConvexClient
    ): Promise<void> {
      const convex = client || getConvexClient();
      await convex.mutation("api/tasks:addTaskLog", args);
    }

    /**
     * Get task by ID
     */
    export async function getTask(
      taskId: string,
      client?: ConvexClient
    ): Promise<Task | null> {
      const convex = client || getConvexClient();
      const task = await convex.query("api/tasks:getTask", { taskId });
      return task;
    }
    ```

    Key decisions:
    - Uses Task, TaskStatus, TaskPriority from shared-types (not redefined)
    - Each function accepts optional ConvexClient for flexibility
    - Returns strongly-typed values (not any)
    - Matches Convex backend function names and signatures

    Note: Convex's TypeScript generation should provide stricter types, but for Phase 13 we use manual typing until we set up codegen.
  </action>
  <verify>
    - Run `tsc --noEmit` in packages/convex-client - should compile without errors
    - Verify types from @convex-poc/shared-types are importable
    - Test function signatures match expected usage
    - Check that all backend functions have corresponding wrappers
  </verify>
  <done>
    Type-safe task wrappers are created and compile successfully
  </done>
</task>

<task type="auto">
  <name>Create type-safe subtask query/mutation wrappers</name>
  <files>packages/convex-client/src/subtasks.ts</files>
  <action>
    Create type-safe wrappers for subtask operations:

    **File: `packages/convex-client/src/subtasks.ts`**
    ```typescript
    import type { ConvexClient } from "convex/browser";

    import type { SubTask, SubTaskStatus } from "@convex-poc/shared-types/subtask";
    import type { Log } from "@convex-poc/shared-types/log";

    import { getConvexClient } from "./client";

    /**
     * Get subtasks by task ID (for "Sub-tasks" column)
     */
    export async function getSubTasksByTask(
      taskId: string,
      client?: ConvexClient
    ): Promise<SubTask[]> {
      const convex = client || getConvexClient();
      return await convex.query("api/subtasks:getSubTasksByTask", { taskId });
    }

    /**
     * Create a new subtask
     */
    export async function createSubTask(
      args: {
        taskId: string;
        title: string;
        agentType: string;
        totalSteps: number;
      },
      client?: ConvexClient
    ): Promise<string> {
      const convex = client || getConvexClient();
      const subtaskId = await convex.mutation("api/subtasks:createSubTask", args);
      return subtaskId;
    }

    /**
     * Update subtask status
     */
    export async function updateSubTaskStatus(
      args: {
        subtaskId: string;
        status: SubTaskStatus;
      },
      client?: ConvexClient
    ): Promise<void> {
      const convex = client || getConvexClient();
      await convex.mutation("api/subtasks:updateSubTaskStatus", args);
    }

    /**
     * Update subtask progress (stepNumber)
     */
    export async function updateSubTaskProgress(
      args: {
        subtaskId: string;
        stepNumber: number;
      },
      client?: ConvexClient
    ): Promise<void> {
      const convex = client || getConvexClient();
      await convex.mutation("api/subtasks:updateSubTaskProgress", args);
    }

    /**
     * Add log to subtask
     */
    export async function addSubTaskLog(
      args: {
        subtaskId: string;
        message: string;
        level: "info" | "warning" | "error";
        source?: string;
      },
      client?: ConvexClient
    ): Promise<void> {
      const convex = client || getConvexClient();
      await convex.mutation("api/subtasks:addSubTaskLog", args);
    }

    /**
     * Get subtask by ID
     */
    export async function getSubTask(
      subtaskId: string,
      client?: ConvexClient
    ): Promise<SubTask | null> {
      const convex = client || getConvexClient();
      const subtask = await convex.query("api/subtasks:getSubTask", { subtaskId });
      return subtask;
    }
    ```

    Key decisions:
    - Uses SubTask, SubTaskStatus from shared-types
    - Matches Convex backend function names exactly
    - Same optional client pattern as tasks.ts
    - Returns string IDs for create functions (not full objects)
  </action>
  <verify>
    - Run `tsc --noEmit` in packages/convex-client - should compile without errors
    - Verify all backend subtask functions have corresponding wrappers
    - Test type inference from shared-types
    - Run `turbo run build` to ensure package builds in dependency order
  </verify>
  <done>
    Type-safe subtask wrappers are created and package builds successfully
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
- `pnpm install` resolves all dependencies
- `tsc --noEmit` compiles without errors
- `turbo run build` succeeds in dependency order
- All task and subtask backend functions have wrappers
- Types from @convex-poc/shared-types are used throughout
- package.json exports field is configured
- No barrel files exist
</verification>

<success_criteria>
1. @convex-poc/convex-client package exists with type-safe wrappers
2. Convex client initialization module with singleton pattern
3. All task and subtask backend functions have corresponding wrappers
4. TypeScript types from shared-types are imported and used
5. Package builds successfully with Turborepo
</success_criteria>

<output>
After completion, create `.planning/phases/13-foundation/13-04-SUMMARY.md`
</output>

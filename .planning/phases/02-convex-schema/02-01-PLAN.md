---
phase: 02-convex-schema
plan: 01
type: execute
domain: convex
---

<objective>
Define Convex schema for agent sessions and workflows with proper indexing.

Purpose: Establish the data model foundation for agent state storage and orchestration tracking.
Output: Deployed Convex schema with agentSessions and workflows tables.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-convex-schema/02-RESEARCH.md
@.planning/STATE.md
@.planning/phases/01-project-setup/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define agentSessions table with fields and indexes</name>
  <files>convex/schema.ts</files>
  <action>
    Update convex/schema.ts to define agentSessions table:

    Fields:
    - agentType: v.string() - "planner" | "coder" | "reviewer"
    - status: v.string() - "idle" | "running" | "completed" | "failed"
    - sessionId: v.optional(v.string()) - Claude SDK session ID
    - input: v.string() - Task or input prompt
    - output: v.optional(v.string()) - Agent's output/result
    - error: v.optional(v.string()) - Error message if failed
    - metadata: v.optional(v.object({
        workflowId: v.id("workflows"),
        startedAt: v.number(),
        completedAt: v.optional(v.number()),
      }))

    Indexes:
    - .index("by_workflow", ["workflowId"]) - Query all sessions for a workflow
    - .index("by_status", ["status"]) - Query all sessions by status (e.g., all running)

    Follow EXACT pattern from 02-RESEARCH.md Pattern 1: Schema Definition with Validators.
    DO NOT add circular references (workflows → agentSessions is fine, agentSessions → workflows avoids circularity).
  </action>
  <verify>
    cat convex/schema.ts shows agentSessions table definition
    Schema has v.string(), v.optional(), v.id(), v.object(), v.array() validators
    Indexes defined: by_workflow, by_status
  </verify>
  <done>
    agentSessions table defined with all required fields
    Two indexes created for efficient querying
  </done>
</task>

<task type="auto">
  <name>Task 2: Define workflows table with fields and indexes</name>
  <files>convex/schema.ts</files>
  <action>
    Add workflows table to convex/schema.ts (same file, same defineSchema call):

    Fields:
    - task: v.string() - Original user task
    - status: v.string() - "pending" | "in_progress" | "completed" | "failed"
    - currentStep: v.string() - Current agent in sequence (e.g., "planner", "coder")
    - artifacts: v.array(v.string()) - File paths to artifacts (plan.md, code.ts, review.md)
    - metadata: v.object({
        createdAt: v.number(),
        updatedAt: v.number(),
      })

    Indexes:
    - .index("by_status", ["status"]) - Query workflows by status

    Follow EXACT pattern from 02-RESEARCH.md Pattern 1.
    metadata is NOT optional (always have createdAt/updatedAt).
  </action>
  <verify>
    cat convex/schema.ts shows workflows table definition
    Schema has v.string(), v.array(), v.object() validators
    Index by_status defined
  </verify>
  <done>
    workflows table defined with all required fields
    Index created for status-based queries
  </done>
</task>

<task type="auto">
  <name>Task 3: Deploy schema to Convex backend</name>
  <files>convex/_generated/dataModel.d.ts, convex/_generated/api.ts, convex/_generated/server.d.ts</files>
  <action>
    Deploy schema to self-hosted Convex:
    1. Ensure CONVEX_SELF_HOSTED_URL and CONVEX_SELF_HOSTED_ADMIN_KEY are set in .env
    2. Run: npx convex deploy
    3. Verify auto-generated files are created in convex/_generated/

    If deployment fails:
    - Check Docker services: docker-compose ps
    - Check backend logs: docker-compose logs convex-backend
    - Verify .env file exists with CONVEX_SELF_HOSTED_ADMIN_KEY

    DO NOT use convex dev (that's for development with watch mode). Use convex deploy for one-time schema deployment.
  </action>
  <verify>
    ls convex/_generated/ shows dataModel.d.ts, api.ts, server.d.ts
    cat convex/_generated/dataModel.d.ts shows Doc<"agentSessions"> and Doc<"workflows"> types
    Schema is visible in Convex dashboard at http://localhost:6791
  </verify>
  <done>
    Schema deployed successfully to Convex backend
    Auto-generated TypeScript types created
    Tables visible in Convex dashboard
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] convex/schema.ts has both agentSessions and workflows tables
- [ ] All required fields defined with proper v.* validators
- [ ] Indexes defined on both tables
- [ ] `npx convex deploy` succeeded
- [ ] Auto-generated files exist in convex/_generated/
- [ ] Tables visible in Convex dashboard
</verification>

<success_criteria>

- All three tasks completed
- Schema deployed to Convex backend
- TypeScript types auto-generated from schema
- Ready for Plan 02 (helper functions implementation)
  </success_criteria>

<output>
After completion, create `.planning/phases/02-convex-schema/02-01-SUMMARY.md`:

# Phase 2 Plan 1: Schema Definition Summary

**Convex schema defined and deployed with agentSessions and workflows tables.**

## Accomplishments

- Defined agentSessions table with agentType, status, sessionId, input, output, error, metadata fields
- Defined workflows table with task, status, currentStep, artifacts, metadata fields
- Created indexes: by_workflow, by_status for agentSessions; by_status for workflows
- Deployed schema to self-hosted Convex backend
- Auto-generated TypeScript types (Doc<"agentSessions">, Doc<"workflows">)

## Files Created/Modified

- `convex/schema.ts` - Complete schema with both tables
- `convex/_generated/dataModel.d.ts` - Auto-generated document types
- `convex/_generated/api.ts` - Auto-generated function API types
- `convex/_generated/server.d.ts` - Auto-generated server types

## Decisions Made

- agentSessions → workflows reference (workflowId in metadata) avoids circular references
- Indexes on status fields for efficient querying (find all running sessions, pending workflows)
- metadata.timestamp fields (startedAt, completedAt, createdAt, updatedAt) for tracking
- Artifacts stored as array of file paths (filesystem separation of concerns from PROJECT.md)

## Issues Encountered

[Or "None" - e.g., "Convex backend not running, resolved with docker-compose up -d"]

## Next Step

Ready for 02-02-PLAN.md (Helper Functions + Basic CRUD)

Schema is deployed and types are generated. Next plan will implement helper functions in model/ and public API (queries/mutations) for agent and workflow operations.
</output>

---
phase: 02-convex-schema
plan: 02
type: execute
domain: convex
---

<objective>
Implement helper functions and public API for agent and workflow operations.

Purpose: Create reusable business logic functions and public Convex functions following best practices for separation of concerns.
Output: Working Convex functions (mutations, queries) with helper functions in model/ directory.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-convex-schema/02-RESEARCH.md
@.planning/phases/02-convex-schema/02-01-SUMMARY.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create model/agents.ts with helper functions</name>
  <files>convex/model/agents.ts</files>
  <action>
    Create convex/model/ directory and model/agents.ts file:

    Helper functions (export async functions):
    - createAgentSession(ctx: MutationCtx, args: { agentType, input, workflowId })
      Inserts agentSessions document with status="running", metadata.startedAt=Date.now()
      Returns: Id<"agentSessions">

    - updateAgentSession(ctx: MutationCtx, sessionId, updates: { output?, error?, status })
      Patches agentSessions document with updates and metadata.completedAt=Date.now()
      Returns: void

    - getAgentSession(ctx: QueryCtx, sessionId)
      Queries agentSessions by ID
      Returns: Doc<"agentSessions"> | null

    Follow Pattern 3 from 02-RESEARCH.md: "Separating Public API from Helper Functions".
    Helper functions take QueryCtx or MutationCtx as first parameter.
    DO NOT create query/mutation wrappers here (that's Task 3).
  </action>
  <verify>
    cat convex/model/agents.ts shows three exported async functions
    Functions use QueryCtx and MutationCtx from "../_generated/server"
    Functions use db.insert, db.patch, db.get operations
  </verify>
  <done>
    convex/model/agents.ts created with three helper functions
    Functions follow separation-of-concerns pattern (no Convex API wrappers)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create model/workflows.ts with helper functions</name>
  <files>convex/model/workflows.ts</files>
  <action>
    Create convex/model/workflows.ts file:

    Helper functions (export async functions):
    - createWorkflow(ctx: MutationCtx, task: string)
      Inserts workflows document with status="pending", currentStep="planner", artifacts=[], metadata.createdAt/updatedAt=Date.now()
      Returns: Id<"workflows">

    - updateWorkflowStatus(ctx: MutationCtx, workflowId, status, currentStep?)
      Patches workflows document with status, optionally currentStep, and metadata.updatedAt=Date.now()
      Returns: void

    - getWorkflow(ctx: QueryCtx, workflowId)
      Queries workflows by ID
      Returns: Doc<"workflows"> | null

    Follow same pattern as model/agents.ts.
    Metadata fields (createdAt, updatedAt) should always be updated appropriately.
  </action>
  <verify>
    cat convex/model/workflows.ts shows three exported async functions
    Functions use QueryCtx and MutationCtx
    Functions handle metadata timestamps correctly
  </verify>
  <done>
    convex/model/workflows.ts created with three helper functions
    Timestamp management logic implemented correctly
  </done>
</task>

<task type="auto">
  <name>Task 3: Create public API (agents.ts, workflows.ts) with mutations/queries</name>
  <files>convex/agents.ts, convex/workflows.ts</files>
  <action>
    Create convex/agents.ts (public API):
    - createAgentSession mutation with v.string() args: agentType, input, workflowId
      Handler: calls Agents.createAgentSession helper, returns sessionId
    - updateAgentSession mutation with v.id("agentSessions") sessionId, v.optional(v.string()) output/error/status
      Handler: calls Agents.updateAgentSession helper
    - getAgentSession query with v.id("agentSessions") sessionId
      Handler: calls Agents.getAgentSession helper, returns session document

    Create convex/workflows.ts (public API):
    - createWorkflow mutation with v.string() task
      Handler: calls Workflows.createWorkflow helper, returns workflowId
    - updateWorkflowStatus mutation with v.id("workflows") workflowId, v.string() status, v.optional(v.string()) currentStep
      Handler: calls Workflows.updateWorkflowStatus helper
    - getWorkflow query with v.id("workflows") workflowId
      Handler: calls Workflows.getWorkflow helper, returns workflow document

    Follow "Pattern 3: Separating Public API from Helper Functions" from 02-RESEARCH.md.
    Import helper functions with `import * as Agents from "./model/agents"` syntax.
    All public functions MUST have args defined with v.* validators (security best practice).
  </action>
  <verify>
    cat convex/agents.ts shows 3 functions (mutation, mutation, query) with arg validators
    cat convex/workflows.ts shows 3 functions (mutation, mutation, query) with arg validators
    All functions call corresponding helper functions from model/
    All args use v.* validators (v.string(), v.id(), v.optional())
  </verify>
  <done>
    Public API created for both agents and workflows
    All functions have proper argument validators
    Helper functions imported and called correctly
  </done>
</task>

<task type="auto">
  <name>Task 4: Deploy and verify functions</name>
  <files>convex/_generated/, Convex dashboard</files>
  <action>
    Deploy functions to Convex:
    1. Run: npx convex deploy
    2. Verify functions appear in Convex dashboard under "Functions"
    3. Check that each function has proper type definitions

    If deployment fails:
    - Check TypeScript errors: npx tsc --noEmit
    - Check schema is deployed (from Plan 01)
    - Verify import paths are correct (convex/_generated/server)

    Test functions can be called (optional verification):
    - Can manually test via dashboard or create a simple test script
    - For POC, dashboard verification is sufficient
  </action>
  <verify>
    npx convex deploy succeeds without errors
    Convex dashboard shows functions: agents.createAgentSession, agents.updateAgentSession, agents.getAgentSession
    Convex dashboard shows functions: workflows.createWorkflow, workflows.updateWorkflowStatus, workflows.getWorkflow
    Function signatures in dashboard match defined arg validators
  </verify>
  <done>
    All functions deployed to Convex backend
    Functions visible and testable in Convex dashboard
    Auto-generated API types updated in convex/_generated/api.ts
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] convex/model/agents.ts created with 3 helper functions
- [ ] convex/model/workflows.ts created with 3 helper functions
- [ ] convex/agents.ts created with 3 public functions (2 mutations, 1 query)
- [ ] convex/workflows.ts created with 3 public functions (2 mutations, 1 query)
- [ ] All public functions have v.* argument validators
- [ ] `npx convex deploy` succeeded
- [ ] Functions visible in Convex dashboard
</verification>

<success_criteria>

- All four tasks completed
- Helper functions implemented in model/ directory
- Public API created with proper argument validators
- Functions deployed and accessible
- Phase 2 complete, ready for Phase 3 (Agent Foundation)
  </success_criteria>

<output>
After completion, create `.planning/phases/02-convex-schema/02-02-SUMMARY.md`:

# Phase 2 Plan 2: Helper Functions + API Summary

**Implemented helper functions and public API following best practices for separation of concerns.**

## Accomplishments

- Created model/agents.ts with createAgentSession, updateAgentSession, getAgentSession helpers
- Created model/workflows.ts with createWorkflow, updateWorkflowStatus, getWorkflow helpers
- Created convex/agents.ts public API with 3 functions (createAgentSession mutation, updateAgentSession mutation, getAgentSession query)
- Created convex/workflows.ts public API with 3 functions (createWorkflow mutation, updateWorkflowStatus mutation, getWorkflow query)
- All functions deployed to Convex backend with proper argument validators
- Functions accessible via Convex dashboard

## Files Created/Modified

- `convex/model/agents.ts` - Agent state helper functions
- `convex/model/workflows.ts` - Workflow logic helper functions
- `convex/agents.ts` - Public API for agent operations
- `convex/workflows.ts` - Public API for workflow operations
- `convex/_generated/api.ts` - Updated with new function types

## Decisions Made

- Helper functions in model/ directory (separation of concerns pattern from research)
- Public functions as thin wrappers calling helpers (best practice from docs)
- All public functions have v.* argument validators (security requirement)
- Timestamps managed in helper functions (createdAt on create, updatedAt on update)
- No access control logic yet (will be added if needed in later phases)

## Issues Encountered

[Or "None" - e.g., "Import path error resolved by using correct _generated/server path"]

## Next Phase Readiness

Phase 2 complete. Ready for Phase 3: Agent Foundation with Convex.

Schema is deployed, helper functions implemented, public API available. Next phase will create base agent class that integrates Claude SDK with Convex state storage using the helper functions created here.
</output>

---
phase: 04-planner-agent
type: execute
---

<objective>
Create PlannerAgent that extends BaseAgent to decompose tasks into actionable steps and store plans in Convex workflows.

Purpose: Implement the first specialized agent that demonstrates task decomposition with Convex state tracking.
Output: Working PlannerAgent class with planning-focused system prompt and integration tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (relevant to planner agent):
@.planning/phases/03-agent-foundation/03-01-SUMMARY.md
@.planning/phases/02-convex-schema/02-01-SUMMARY.md

# Key files from prior phases:
@src/agents/BaseAgent.ts
@src/agents/README.md
@src/types/agent.ts
@convex/schema.ts
@convex/workflows.ts
@convex/model/workflows.ts

# Tech stack available:
- BaseAgent abstract class (Phase 3)
- @anthropic-ai/claude-agent-sdk: 0.2.7
- convex: 1.31.4
- Convex workflows table with task, status, currentStep, artifacts fields
- Helper functions: createWorkflow, updateWorkflowStatus, getWorkflow

# Established patterns:
- Pattern 1: Extend BaseAgent and implement getSystemPrompt() only
- Pattern 2: ES module imports with .js extensions for nodenext resolution
- Pattern 3: Hooks use HookCallbackMatcher[] array structure
- Pattern 4: Error handling in hooks prevents crashes

# Constraining decisions:
- Phase 03-01: Abstract BaseAgent class with protected Convex integration methods
- Phase 03-01: Subclasses implement only getSystemPrompt() - BaseAgent handles all Convex details
- Phase 03-01: Manual persistence via execute() calls
- Phase 02-01: Workflows table with task, status, currentStep, artifacts fields
- Phase 02-02: Helper functions in model/ directory follow separation-of-concerns pattern

# No research or context files exist for Phase 4 - this is Level 0 discovery (internal prompt engineering only)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PlannerAgent class extending BaseAgent</name>
  <files>src/agents/PlannerAgent.ts, src/types/plan.ts</files>
  <action>
Create PlannerAgent class in src/agents/PlannerAgent.ts:

1. Define PlanResult interface in src/types/plan.ts:
   ```typescript
   export interface PlanResult {
     steps: Array<{
       description: string;
       agent: string;
       dependencies: string[];
     }>;
     estimatedDuration?: string;
     risks?: string[];
   }
   ```

2. PlannerAgent extends BaseAgent:
   - Constructor accepts AgentConfig (passes to super)
   - agentType defaults to "planner"
   - Optional: planning-specific config (e.g., detailLevel: "basic" | "detailed")

3. Implement getSystemPrompt():
   - Role: "You are a Planner Agent that breaks down tasks into clear, actionable steps."
   - Responsibilities:
     * Analyze the input task and identify subtasks
     * Assign each subtask to an agent type (planner, coder, reviewer)
     * Identify dependencies between steps
     * Estimate complexity and risks
   - Output format: Structured plan as JSON matching PlanResult interface
   - Guidelines:
     * Break tasks into 3-7 steps (not too granular, not too vague)
     * Each step should be clear and independently verifiable
     * Coder steps for implementation work
     * Reviewer steps for validation
     * Identify what can be done in parallel vs sequential

4. Override execute() to return parsed PlanResult:
   - Call super.execute() to get raw response
   - Parse JSON response from Claude
   - Validate against PlanResult interface
   - Return typed PlanResult

5. Don't create Convex workflow in this task - that's Task 2
   - For now, PlannerAgent just generates plans
   - Workflow integration happens in executeWithWorkflow()

Follow BaseAgent extension pattern from src/agents/README.md and Phase 3.
Use ES module imports with .js extensions.
  </action>
  <verify>
TypeScript compilation succeeds: npx tsc --noEmit
PlannerAgent can be instantiated and getSystemPrompt() returns planning-focused prompt
  </verify>
  <done>
PlannerAgent extends BaseAgent, implements planning-focused system prompt, execute() returns PlanResult
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Convex workflow integration to PlannerAgent</name>
  <files>src/agents/PlannerAgent.ts, src/agents/index.ts</files>
  <action>
Add executeWithWorkflow() method to PlannerAgent:

1. Create executeWithWorkflow(input: string, workflowId: Id<"workflows">): Promise<PlanResult>
   - Stores workflowId for BaseAgent hooks to use
   - Calls execute(input) to generate plan
   - Creates workflow step entries in Convex if needed
   - Returns PlanResult

2. Update BaseAgent integration:
   - Pass workflowId to super constructor (already supported by AgentConfig)
   - BaseAgent hooks will create agent session linked to this workflow
   - SessionStart hook creates session with workflowId association
   - SessionEnd hook updates session with plan output

3. Add plan persistence (optional):
   - Method to store generated plan in Convex workflows table
   - Could use artifacts array to store step descriptions
   - Or store as JSON string in a dedicated field
   - For now: Keep it simple - just return PlanResult, caller handles storage

4. Export PlannerAgent from src/agents/index.ts:
   - Add: export { PlannerAgent } from './PlannerAgent.js'

Note: Full Convex integration is limited by ISS-001 (backend deployment).
For now, plan storage logic should be prepared but may use placeholder client.
  </action>
  <verify>
TypeScript compilation succeeds
PlannerAgent exported from index.ts
  </verify>
  <done>
executeWithWorkflow() method implemented, PlannerAgent exported, Convex integration prepared
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PlannerAgent tests and documentation</name>
  <files>tests/planner.test.ts, src/agents/README.md</files>
  <action>
Create comprehensive tests for PlannerAgent:

1. tests/planner.test.ts:
   - Test 1: PlannerAgent instantiates with correct config
   - Test 2: getSystemPrompt() returns planning-focused prompt
   - Test 3: PlannerAgent extends BaseAgent
   - Test 4: execute() returns structured PlanResult (mock the SDK call)
   - Test 5: PlanResult has expected structure (steps array, each step with description/agent/dependencies)
   - Test 6: Steps are reasonable (3-7 items, not empty, not too many)

2. For execute() tests, mock the Claude SDK:
   - Don't make real API calls in tests
   - Mock query() to return sample plan JSON
   - Test JSON parsing and PlanResult validation

3. Update src/agents/README.md:
   - Add PlannerAgent section under "Example: DummyAgent"
   - Document planning-specific behavior
   - Show example: creating planner, generating plan, accessing PlanResult
   - Note: PlannerAgent for task decomposition, CoderAgent for implementation

4. Run tests to verify:
   - npm test (or vitest run)
   - All new tests pass

Follow test patterns from tests/agents.test.ts (Phase 3).
  </action>
  <verify>
All tests pass: npm test
PlannerAgent documented in README.md
  </verify>
  <done>
PlannerAgent has comprehensive tests, documentation shows usage example, all tests pass
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] TypeScript compiles without errors: npx tsc --noEmit
- [ ] PlannerAgent extends BaseAgent and implements getSystemPrompt()
- [ ] execute() returns typed PlanResult with steps array
- [ ] Tests cover instantiation, prompt structure, and plan parsing
- [ ] README.md documents PlannerAgent usage
- [ ] Code follows established patterns from Phase 3
</verification>

<success_criteria>

- PlannerAgent class created extending BaseAgent
- Planning-focused system prompt for task decomposition
- PlanResult interface defined for structured output
- Tests verify planner generates valid plans
- Documentation shows how to use PlannerAgent
- Ready for Phase 5 (CoderAgent) and Phase 6 (ReviewerAgent)
  </success_criteria>

<output>
After completion, create `.planning/phases/04-planner-agent/04-01-SUMMARY.md`:

# Phase 4 Plan 1: Planner Agent Summary

**PlannerAgent created for task decomposition with structured plan output and Convex workflow integration.**

## Accomplishments

- Created PlannerAgent extending BaseAgent with planning-focused system prompt
- Defined PlanResult interface for structured task decomposition
- Implemented execute() method returning typed PlanResult
- Added workflow integration via executeWithWorkflow()
- Created comprehensive tests for plan generation
- Documented PlannerAgent usage patterns

## Files Created/Modified

- `src/agents/PlannerAgent.ts` - Planner agent extending BaseAgent
- `src/types/plan.ts` - PlanResult interface
- `src/agents/index.ts` - Export barrel updated with PlannerAgent
- `tests/planner.test.ts` - PlannerAgent tests
- `src/agents/README.md` - Updated with PlannerAgent documentation

## Decisions Made

- PlannerAgent focuses on task decomposition only (not execution)
- Plan output as structured JSON for programmatic use
- Steps limited to 3-7 for balance between detail and complexity
- Agent assignment per step (coder/reviewer) for future orchestration

## Issues Encountered

[Or "None"]

## Next Step

Phase 4 complete. Ready for Phase 5: Coder Agent.
</output>

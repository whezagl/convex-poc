---
phase: 10-convex-deployment
plan: 01
type: execute
tags: convex, docker, deployment, infrastructure
---

<objective>
Deploy self-hosted Convex backend and replace placeholder client with real integration, resolving ISS-001.

Purpose: Complete the Convex integration that was designed but not deployed in Phase 09. The schema, helper functions, and agent hooks are all implemented - this phase deploys them to a running self-hosted Convex backend.

Output: Working self-hosted Convex backend with deployed schema/functions, real Convex client replacing placeholder, and verified end-to-end integration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ISSUES.md

# Prior summaries (dependency graph):
@.planning/phases/02-convex-schema/02-01-SUMMARY.md
@.planning/phases/02-convex-schema/02-02-SUMMARY.md
@.planning/phases/03-agent-foundation/03-01-SUMMARY.md
@.planning/phases/09-documentation/09-01-SUMMARY.md

# Key files to modify:
@src/convex/client.ts
@src/agents/BaseAgent.ts
@docker-compose.yml
@convex/schema.ts

# External reference (setup guide):
/Users/wharsojo/dev/convex-pocx/SELF_HOSTED_SETUP_GUIDE.md

**Tech stack available:**
- Docker Compose for self-hosted Convex (from Phase 01-02)
- Convex schema defined (agentSessions, workflows tables)
- Helper functions implemented (model/agents.ts, model/workflows.ts)
- Public API functions (agents.ts, workflows.ts)
- BaseAgent with placeholder hooks (lines 96-101, 121-125)

**Established patterns:**
- Helper functions in model/ directory with QueryCtx/MutationCtx pattern
- Public API with v.* argument validators
- Timestamps managed in helpers (createdAt, updatedAt)
- Placeholder client logs operations for debugging

**Constraining decisions:**
- Phase 02-01: Nested metadata object for agentSessions (workflowId reference avoids circularity)
- Phase 02-02: Helper functions follow separation-of-concerns pattern
- Phase 03-01: Abstract BaseAgent class with protected Convex integration methods
- Phase 09-01: Placeholder client is intentional for POC scope, but now we're deploying for real

**Issues being addressed:**
- ISS-001: Self-hosted Convex backend deployment authentication failure (401 Unauthorized)

**Concerns to verify:**
- From Phase 02-02: "Backend deployment is pending ISS-001 resolution"
- From Phase 09-01: "Convex integration designed but not deployed for POC"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Start self-hosted Convex and generate admin key</name>
  <files>docker-compose.yml, .env.local</files>
  <action>
    Start Docker Compose services for Convex backend and dashboard:
    1. Run `docker compose up -d` to start convex-backend and convex-dashboard
    2. Wait for backend to be healthy: `docker compose ps` shows "healthy" status
    3. Generate admin key: `docker compose exec backend ./generate_admin_key.sh`
    4. Copy the generated admin key (format: convex-poc|...)
    5. Update .env.local with CONVEX_SELF_HOSTED_ADMIN_KEY (create file if missing)
    6. Also set CONVEX_SELF_HOSTED_URL=http://127.0.0.1:3210 in .env.local
    7. Restart Docker services: `docker compose down && docker compose up -d`

    Do NOT proceed without a valid admin key. The 401 error in ISS-001 was caused by missing/invalid admin key.
  </action>
  <verify>
    `docker compose ps` shows both services running and backend status as "healthy"
    Dashboard loads at http://localhost:6791 and accepts the admin key for login
  </verify>
  <done>
    Convex backend and dashboard are running, admin key is set in .env.local, dashboard is accessible
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Self-hosted Convex backend and dashboard running via Docker</what-built>
  <how-to-verify>
    1. Run: `docker compose ps` - confirm convex-backend shows "healthy" status
    2. Visit: http://localhost:6791
    3. Login with the admin key you generated
    4. Confirm: You can see the Convex dashboard interface (it will be empty - no schema deployed yet)
  </how-to-verify>
  <resume-signal>Type "approved" to continue with deployment, or describe issues</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Deploy schema and functions to Convex backend</name>
  <files>convex/schema.ts, convex/agents.ts, convex/workflows.ts</files>
  <action>
    Deploy the Convex schema and functions to the self-hosted backend:
    1. Set environment variables for Convex CLI:
       - `export CONVEX_SELF_HOSTED_URL="http://127.0.0.1:3210"`
       - `export CONVEX_SELF_HOSTED_ADMIN_KEY="<your-key-from-.env.local>"`
    2. Run `npx convex deploy` to deploy schema and functions
    3. Verify deployment succeeded (should show "Deployed Convex function" messages)
    4. Run `npx convex codegen` to regenerate TypeScript types from deployed schema
    5. Verify generated types exist in convex/_generated/

    If deployment fails with 401:
    - Verify admin key is set correctly
    - Check backend is healthy: `docker compose ps`
    - Try restarting backend: `docker compose restart backend`
  </action>
  <verify>
    `npx convex deploy` completes without errors
    Dashboard at http://localhost:6791 shows deployed functions under "Functions"
    convex/_generated/dataModel.d.ts exists and is up-to-date
  </verify>
  <done>
    Schema and functions deployed to self-hosted Convex, types regenerated, dashboard shows deployed functions
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Deployed Convex schema (agentSessions, workflows tables) and functions (agents, workflows)</what-built>
  <how-to-verify>
    1. Visit: http://localhost:6791
    2. Navigate to "Functions" in dashboard
    3. Confirm: You see agentSessions and workflows tables
    4. Confirm: You see functions like createAgentSession, updateAgentSession, getAgentSession
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Replace placeholder client with real Convex client</name>
  <files>src/convex/client.ts</files>
  <action>
    Replace the placeholder client with real Convex integration:
    1. Create real ConvexClient using `convex-dev` package
    2. Configure client with CONVEX_SELF_HOSTED_URL and CONVEX_SELF_HOSTED_ADMIN_KEY
    3. Implement mutations.agents.createAgentSession using convex.mutation()
    4. Implement mutations.agents.updateAgentSession using convex.mutation()
    5. Implement queries.agents.getAgentSession using convex.query()
    6. Keep console.log for debugging (helpful for verifying integration)
    7. Update header comment to reflect deployment is complete

    Example structure:
    ```typescript
    import { ConvexClient } from "convex-dev";

    const client = new ConvexClient(
      process.env.CONVEX_SELF_HOSTED_URL || "http://127.0.0.1:3210",
      {
        adminKey: process.env.CONVEX_SELF_HOSTED_ADMIN_KEY,
      }
    );

    export const convex = {
      mutations: {
        agents: {
          createAgentSession: async (args) => {
            console.log("[Convex] Creating agent session", args);
            return await client.mutation("agents.createAgentSession", args);
          },
          // ... other mutations
        },
      },
      queries: {
        agents: {
          getAgentSession: async (args) => {
            console.log("[Convex] Getting agent session", args);
            return await client.query("agents.getAgentSession", args);
          },
        },
      },
    };
    ```

    Do NOT change the API surface - the function signatures must remain the same for BaseAgent compatibility.
  </action>
  <verify>
    TypeScript compilation succeeds: `npm run build` passes
    No type errors in BaseAgent.ts imports
  </verify>
  <done>
    Real Convex client replaces placeholder, API surface unchanged, types compile correctly
  </done>
</task>

<task type="auto">
  <name>Task 4: Enable Convex mutations in BaseAgent</name>
  <files>src/agents/BaseAgent.ts</files>
  <action>
    Uncomment and enable the Convex integration hooks in BaseAgent:
    1. Uncomment lines 96-101 (createAgentSession in SessionStart hook)
    2. Uncomment lines 121-125 (updateAgentSession in SessionEnd hook)
    3. Update buildConvexContext() to return actual context (currently returns {})
    4. Update extractOutput() to extract real output from HookInput structure
    5. Remove TODO comments at lines 72 and 173
    6. Add error handling for Convex failures (already present in try-catch)

    For buildConvexContext(), return the Convex client context or session metadata.

    For extractOutput(), investigate the HookInput type from @anthropic-ai/claude-agent-sdk to understand the actual structure. The current placeholder returns "Session completed" - implement real extraction based on SDK types.

    Keep the console.log statements - they help verify integration is working.
  </action>
  <verify>
    `npm run build` succeeds without TypeScript errors
    No TODO comments remain related to Convex integration
    Hook code references convex.mutations and convex.queries (not commented out)
  </verify>
  <done>
    BaseAgent creates/updates sessions in Convex, no Convex-related TODOs remain
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `docker compose ps` shows convex-backend as "healthy"
- [ ] Dashboard at http://localhost:6791 is accessible with admin key
- [ ] `npx convex deploy` succeeded (functions visible in dashboard)
- [ ] `npm run build` succeeds without errors
- [ ] No Convex-related TODO comments remain in codebase
- [ ] BaseAgent creates real Convex sessions (check console logs when running agent)
</verification>

<success_criteria>
- Self-hosted Convex backend running via Docker Compose
- Schema and functions deployed (agentSessions, workflows tables + CRUD operations)
- Real Convex client replaces placeholder in src/convex/client.ts
- BaseAgent creates/updates sessions in Convex (not placeholders)
- Dashboard shows real data when agents run
- ISS-001 resolved and marked as closed in ISSUES.md
</success_criteria>

<output>
After completion, create `.planning/phases/10-convex-deployment/10-01-SUMMARY.md`:

# Phase 10 Plan 1: Self-Hosted Convex Deployment Summary

**ISS-001 resolved: Self-hosted Convex backend deployed and integrated with real client.**

## Accomplishments

- Self-hosted Convex backend running via Docker Compose with valid admin key
- Schema and functions deployed (agentSessions, workflows tables + 6 API functions)
- Real ConvexClient replaces placeholder in src/convex/client.ts
- BaseAgent now creates/updates sessions in Convex (hooks enabled)
- Dashboard at http://localhost:6791 shows deployed functions and real-time agent data

## Files Created/Modified

- `.env.local` - Admin key and Convex URL configuration
- `src/convex/client.ts` - Real ConvexClient replaces placeholder
- `src/agents/BaseAgent.ts` - Convex mutations uncommented, hooks enabled
- `convex/_generated/dataModel.d.ts` - Regenerated from deployed schema

## Decisions Made

- Used convex-dev package for client (consistent with self-hosted setup)
- Kept console.log statements for debugging integration
- Admin key stored in .env.local (not committed to git)

## Issues Encountered

- [Any issues with admin key generation, deployment, or integration]

## Next Step

ISS-001 closed. Convex integration complete. Project now has full self-hosted Convex backend for agent state storage.
Phase complete. No further phases planned (post-project work).
</output>

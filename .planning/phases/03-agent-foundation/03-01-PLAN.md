---
phase: 03-agent-foundation
type: execute
---

<objective>
Create BaseAgent class that integrates Claude Agent SDK with Convex state storage, providing reusable foundation for specialized agents.

Purpose: Establish the pattern for agent state management with Convex that Planner, Coder, and Reviewer agents will extend in future phases.
Output: Working BaseAgent abstract class with Convex integration, simple test agent proving the pattern, and documented usage.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase research and context:
@.planning/phases/03-agent-foundation/03-RESEARCH.md
@.planning/phases/03-agent-foundation/03-CONTEXT.md

# Prior phase summaries (relevant to agent foundation):
@.planning/phases/02-convex-schema/02-01-SUMMARY.md
@.planning/phases/02-convex-schema/02-02-SUMMARY.md
@.planning/phases/01-project-setup/01-02-SUMMARY.md

# Key files from prior phases (Convex integration layer):
@convex/schema.ts
@convex/model/agents.ts
@convex/agents.ts
@convex/_generated/dataModel.d.ts
@convex/_generated/server.d.ts

# Tech stack available:
- @anthropic-ai/claude-agent-sdk: 0.2.7 (installed Phase 1)
- convex: 1.31.4 (installed Phase 1)
- Self-hosted Convex backend running (Phase 1-02)

# Established patterns:
- Pattern 1: Schema definition with v.* validators (Phase 2-01)
- Pattern 2: Helper functions take QueryCtx/MutationCtx as first parameter (Phase 2-02)
- Pattern 3: Separation of concerns (model/ for business logic, public API for external interface) (Phase 2-02)
- Docker Compose for local development infrastructure (Phase 1-02)

# Constraining decisions:
- Phase 01-02: Self-hosted Convex over Convex Cloud for local development control
- Phase 02-01: Nested metadata object for agentSessions (workflowId reference avoids circularity)
- Phase 02-01: Indexes on status fields for efficient querying
- Phase 02-02: Helper functions in model/ directory follow separation-of-concerns pattern
- Phase 02-02: Public API functions are thin wrappers with v.* argument validators

# User's vision (from 03-CONTEXT.md):
- "more control, less magic" — preferring explicit state persistence over automatic tracking
- Manual state persistence — subclasses explicitly call save/update methods
- Base class should handle the Convex integration details so subclasses don't need to know them
- Include a simple test agent (like a DummyAgent) to prove the pattern works
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BaseAgent abstract class with SDK integration</name>
  <files>src/agents/BaseAgent.ts, src/types/agent.ts</files>
  <action>
Create abstract BaseAgent class in src/agents/BaseAgent.ts:

1. Define AgentConfig interface in src/types/agent.ts:
   - agentType: string
   - model?: string (default 'sonnet')
   - workflowId?: Id<'workflows'>

2. BaseAgent class structure (abstract):
   - Protected fields: sessionId, agentType, workflowId
   - Constructor taking AgentConfig
   - Abstract method: getSystemPrompt(): string (subclasses implement)
   - Protected method: getModel(): string (returns config.model or 'sonnet')
   - Protected method: buildConvexContext(): any (returns Convex context for mutations/queries)
   - Public method: execute(input: string): Promise<string> (main entry point)

3. SDK integration in execute():
   - Import query from '@anthropic-ai/claude-agent-sdk'
   - Build options with hooks (SessionStart, SessionEnd)
   - Call query() with prompt and options
   - Iterate through messages async generator
   - Extract and return final result

4. Hook implementation (buildOptions() protected method):
   - SessionStart: Call convex.model.agents.createAgentSession via public API
   - SessionEnd: Call convex.model.agents.updateAgentSession via public API
   - Set status: 'running' on start, 'completed' on end
   - Handle errors: set status to 'error', store error message

5. Don't store full message history in Convex (blobs documents). Only store essential state (status, output summary, error).

6. Use try-catch in hooks to prevent unhandled rejections from crashing the agent.

Reference RESEARCH.md patterns: "Pattern 1: Abstract Base Class with Protected Methods" and "Pattern 2: Hook-Based Lifecycle Management".

Don't hand-roll: Use existing Convex functions from Phase 2 (convex.agents.createAgentSession, updateAgentSession) instead of writing custom mutations.
  </action>
  <verify>
TypeScript compilation succeeds: npx tsc --noEmit
BaseAgent.ts has no type errors
  </verify>
  <done>
BaseAgent.ts compiles without errors, all abstract methods defined, hooks properly structured for Convex integration
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DummyAgent test class and integration test</name>
  <files>src/agents/DummyAgent.ts, src/agents/index.ts, tests/agents.test.ts</files>
  <action>
Create concrete DummyAgent class extending BaseAgent:

1. src/agents/DummyAgent.ts:
   - Extend BaseAgent
   - Implement getSystemPrompt(): string returning "You are a simple test agent. Respond with 'Dummy agent received: [input]'"
   - Constructor accepts AgentConfig (passes to super())

2. src/agents/index.ts:
   - Export BaseAgent
   - Export DummyAgent
   - Export types from src/types/agent.ts

3. Create integration test in tests/agents.test.ts:
   - Test 1: DummyAgent instantiates with correct config
   - Test 2: getSystemPrompt() returns expected string
   - Test 3: execute() returns expected response format
   - Note: Full integration test with Convex backend requires ISS-001 resolution; for now test instantiation and prompt

4. Don't make real API calls in tests — mock the SDK query() function to test the pattern without Claude API usage.

Use standard TypeScript class inheritance patterns. Keep DummyAgent minimal — its purpose is proving BaseAgent works, not implementing real agent logic.
  </action>
  <verify>
TypeScript compilation succeeds: npx tsc --noEmit
Tests can import DummyAgent from src/agents
  </verify>
  <done>
DummyAgent extends BaseAgent, implements getSystemPrompt(), tests pass (instantiation, prompt structure)
  </done>
</task>

<task type="auto">
  <name>Task 3: Create usage documentation and example</name>
  <files>src/agents/README.md, examples/basic-usage.ts</files>
  <action>
Create documentation for using BaseAgent:

1. src/agents/README.md:
   - Purpose: "Base class for Claude Agent SDK + Convex integration"
   - How to extend: Implement getSystemPrompt(), pass AgentConfig to constructor
   - Usage example: const agent = new DummyAgent({agentType: 'dummy'}); await agent.execute('test input')
   - State persistence: Sessions automatically stored in Convex via hooks
   - Session resumption: Store sessionId from execution, pass to resume options
   - Notes: Manual persistence (call execute() explicitly), BaseAgent handles Convex details

2. examples/basic-usage.ts:
   - Import DummyAgent from src/agents
   - Create workflow (mock or real Convex call)
   - Instantiate agent with AgentConfig
   - Call agent.execute('hello world')
   - Log result
   - Show session ID retrieval

3. Document error handling:
   - Hooks catch errors and update session status to 'error'
   - execute() rethrows for caller to handle

Keep documentation concise but complete. Focus on "how to extend BaseAgent" pattern since that's the primary value.

Note: Full end-to-end example requires ISS-001 resolution (Convex backend deployment). Document as "requires running Convex backend" for now.
  </action>
  <verify>
README.md exists with usage examples
basic-usage.ts compiles without errors
  </verify>
  <done>
Documentation covers: how to extend, usage example, error handling, Convex integration, session resumption
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] TypeScript compiles without errors: npx tsc --noEmit
- [ ] All exports work: import { BaseAgent, DummyAgent } from 'src/agents'
- [ ] Tests pass (instantiation, prompt, inheritance pattern)
- [ ] README.md documents usage and extension pattern
- [ ] Code follows patterns from RESEARCH.md (abstract class, hooks, manual persistence)
</verification>

<success_criteria>

- BaseAgent abstract class created with SDK + Convex integration
- Hooks properly structure for SessionStart/SessionEnd
- DummyAgent extends BaseAgent and proves the pattern
- Documentation shows how to extend BaseAgent
- Code follows established patterns from prior phases
- No deviations from research recommendations
  </success_criteria>

<output>
After completion, create `.planning/phases/03-agent-foundation/03-01-SUMMARY.md`:

# Phase 3 Plan 1: BaseAgent with Convex Integration Summary

**BaseAgent abstract class created with Claude SDK hooks for automatic Convex state persistence.**

## Accomplishments

- Created BaseAgent abstract class with protected Convex integration methods
- Implemented SessionStart/SessionEnd hooks for automatic session tracking
- Created DummyAgent test class proving the extension pattern
- Added documentation for extending BaseAgent
- Established pattern for Phase 4-6 specialized agents

## Files Created/Modified

- `src/agents/BaseAgent.ts` - Abstract base class with SDK + Convex integration
- `src/agents/DummyAgent.ts` - Test agent extending BaseAgent
- `src/agents/index.ts` - Export barrel file
- `src/types/agent.ts` - AgentConfig interface
- `src/agents/README.md` - Usage and extension documentation
- `examples/basic-usage.ts` - Example agent usage
- `tests/agents.test.ts` - Integration tests

## Decisions Made

- Abstract class pattern over functional composition (user preference)
- Hooks for lifecycle management (SessionStart, SessionEnd)
- Manual persistence via execute() calls (no magic state tracking)
- Subclasses implement getSystemPrompt() only
- BaseAgent handles all Convex integration details

## Issues Encountered

[Or "None"]

## Next Step

Phase 3 complete. Ready for Phase 4: Planner Agent.
</output>
